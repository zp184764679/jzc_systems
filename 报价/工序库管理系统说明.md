# 🔧 工序库管理系统说明

## 📅 完成时间
**2025-11-14**

---

## 🎯 开发目标

基于PM项目的Steps界面，创建报价系统专用的工序库管理系统。

**重要**：以后PM系统的工序库将以报价系统的工序为准！

---

## ✅ 已完成的工作

### 1. 后端扩展

#### 1.1 扩展Process模型 (`models/process.py`)

添加了报价系统专用字段：

```python
# 新增字段
daily_fee = Column(DECIMAL(10, 2), default=0, comment="工事费/日 元/天")
icon = Column(String(10), comment="图标emoji")

# 更新字段注释和默认值
setup_time = Column(DECIMAL(10, 4), default=0, comment="段取时间 天")
daily_output = Column(Integer, default=1000, comment="日产量（件/天）")
defect_rate = Column(DECIMAL(5, 4), default=0, comment="不良率 %")
```

#### 1.2 扩展API (`api/processes.py`)

添加了CRUD完整操作：

- ✅ `GET /api/processes` - 列表查询（支持分页、搜索）
- ✅ `POST /api/processes` - 创建工序
- ✅ `PUT /api/processes/{id}` - 更新工序（新增）
- ✅ `DELETE /api/processes/{id}` - 删除工序（软删除，新增）
- ✅ `GET /api/processes/{id}` - 获取详情
- ✅ `GET /api/processes/code/{code}` - 通过代码查询

#### 1.3 更新Schemas (`api/schemas.py`)

添加了新字段到ProcessBase：

```python
daily_fee: Optional[float] = None
icon: Optional[str] = None
```

#### 1.4 数据库迁移脚本

创建了 `migrations/add_process_fields.sql`，用于更新数据库表结构。

---

### 2. 前端界面

#### 2.1 创建工序管理页面 (`frontend/src/pages/ProcessManage.jsx`)

基于PM项目的Steps.jsx，创建了完整的工序库管理界面。

**核心功能**：

1. **列表展示**
   - 分页展示所有工序
   - 实时搜索（工序代码/名称）
   - 字段：序号、代码、名称、类别、不良率、日产、段取时间、工事费/日

2. **新建/编辑工序**
   - 必填字段：工序代码、工序名称
   - 报价参数：不良率、日产、段取时间、工事费/日
   - 可选字段：类别、图标、工时费率、说明
   - 表单验证

3. **删除工序**
   - 确认对话框
   - 软删除（is_active=False）

4. **批量导入**
   - 支持JSON格式
   - 支持CSV格式
   - 自动解析并导入

---

## 🗂️ 数据字段对照表

| 字段 | 说明 | 类型 | 单位 | 默认值 | 必填 |
|------|------|------|------|--------|------|
| process_code | 工序代码 | String | - | - | ✅ |
| process_name | 工序名称 | String | - | - | ✅ |
| category | 工艺类别 | String | - | - | ❌ |
| icon | 图标emoji | String | - | - | ❌ |
| defect_rate | 不良率 | Decimal | % | 0 | ❌ |
| daily_output | 日产量 | Integer | 件/天 | 1000 | ❌ |
| setup_time | 段取时间 | Decimal | 天 | 0 | ❌ |
| daily_fee | 工事费/日 | Decimal | 元/天 | 0 | ❌ |
| hourly_rate | 工时费率 | Decimal | 元/小时 | 0 | ❌ |
| description | 工序说明 | Text | - | - | ❌ |
| is_active | 是否启用 | Boolean | - | True | ❌ |

---

## 🚀 使用步骤

### 步骤1：更新数据库

执行迁移脚本添加新字段：

```bash
cd C:\Users\Admin\Desktop\报价\backend
sqlite3 quote_system.db < migrations/add_process_fields.sql
```

或者使用MySQL客户端执行SQL文件。

### 步骤2：添加路由

在前端路由配置中添加工序管理页面：

```javascript
// App.jsx 或路由配置文件
import ProcessManage from './pages/ProcessManage'

// 添加路由
<Route path="/processes" element={<ProcessManage />} />
```

### 步骤3：访问界面

启动前后端服务后，访问：

```
http://localhost:8000/processes
```

---

## 📦 预置数据示例

### CSV格式示例

```csv
process_code,process_name,category,icon,defect_rate,daily_output,setup_time,daily_fee
CNC_TURNING,CNC车削,车削,🔄,1.0,480,0.125,400
MILLING,铣削,铣削,⚙️,1.0,1500,0.125,0
GRINDING,无芯磨,磨削,✨,0.0,3000,0.125,200
DEBURRING,去披锋,去毛刺,🔧,0.0,3000,0.125,0
INSPECTION,检查,质检,✓,0.0,3000,0.125,100
PLATING,电镀,表面处理,💎,1.0,1000,0,0
```

### JSON格式示例

```json
[
  {
    "process_code": "CNC_TURNING",
    "process_name": "CNC车削",
    "category": "车削",
    "icon": "🔄",
    "defect_rate": 1.0,
    "daily_output": 480,
    "setup_time": 0.125,
    "daily_fee": 400
  },
  {
    "process_code": "GRINDING",
    "process_name": "无芯磨",
    "category": "磨削",
    "icon": "✨",
    "defect_rate": 0.0,
    "daily_output": 3000,
    "setup_time": 0.125,
    "daily_fee": 200
  }
]
```

---

## 🔗 与报价系统集成

工序库数据会在报价创建页面(`QuoteCreate.jsx`)中使用：

### 当前集成方式（硬编码）

```javascript
const processOptions = [
  { code: 'TURNING', name: '车削', icon: '🔄' },
  { code: 'MILLING', name: '铣削', icon: '⚙️' },
  // ...
]
```

### 建议改进为动态加载

```javascript
// 在QuoteCreate.jsx中
const [processOptions, setProcessOptions] = useState([])

useEffect(() => {
  // 从工序库加载
  axios.get('http://localhost:8001/api/processes')
    .then(res => {
      setProcessOptions(res.data.items.map(p => ({
        code: p.process_code,
        name: p.process_name,
        icon: p.icon,
        defectRate: p.defect_rate,
        dailyOutput: p.daily_output,
        setupTime: p.setup_time,
        dailyFee: p.daily_fee
      })))
    })
}, [])
```

---

## 🎯 与PM系统的关系

### 数据流向

```
报价系统工序库（主库）
         ↓
    导出CSV/JSON
         ↓
    PM系统导入
```

### 同步方案

1. **手动导出/导入**
   - 从报价系统导出工序库CSV
   - 导入到PM系统的Steps管理

2. **API同步**（未来开发）
   - PM系统定期调用报价系统API
   - 自动同步工序库数据

---

## 📊 功能对比

| 功能 | PM系统 Steps | 报价系统 ProcessManage | 说明 |
|------|-------------|----------------------|------|
| 工序代码 | ✅ code | ✅ process_code | 通用 |
| 工序名称 | ✅ name | ✅ process_name | 通用 |
| 标准时长 | ✅ std_minutes | ❌ | PM专用 |
| 不良率 | ❌ | ✅ defect_rate | 报价专用 |
| 日产 | ❌ | ✅ daily_output | 报价专用 |
| 段取时间 | ✅ setup_minutes | ✅ setup_time | 单位不同 |
| 工事费/日 | ❌ | ✅ daily_fee | 报价专用 |
| 图标 | ❌ | ✅ icon | 报价专用 |
| 扩展字段 | ✅ meta (JSON) | ❌ | PM专用 |

---

## 🔮 后续优化建议

### 1. 工序模板

创建常用工序组合模板：

```
不锈钢标准工艺 = [CNC车削, 铣扁, 去披锋, 无芯磨, 检查, 电镀]
铝合金简化工艺 = [CNC车削, 铣削, 去毛刺, 检查]
```

### 2. 工序推荐

根据材质自动推荐工艺路线（已有API `/recommend/{material}`）。

### 3. 成本计算器

在工序管理界面添加成本计算器，实时预览工序成本。

### 4. 工序统计

统计最常用的工序、平均成本等数据。

---

## ⚠️ 注意事项

1. **数据一致性**
   - 报价系统是主库，PM系统定期同步
   - 不要在PM系统直接修改工序数据

2. **单位转换**
   - PM: setup_minutes（分钟）
   - 报价: setup_time（天）
   - 转换公式: 天 = 分钟 ÷ 8 ÷ 60

3. **删除操作**
   - 使用软删除（is_active=False）
   - 已被报价单引用的工序不应删除

---

**开发完成时间**：2025-11-14
**开发人员**：Claude Code
**基于**：PM系统 Steps.jsx v2.0
**版本**：报价系统工序库 v1.0
