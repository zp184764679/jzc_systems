# 机加工精密零件报价系统 - 技术架构设计

## 1. 系统概述

### 1.1 项目目标
构建一个智能化的机加工零件报价系统，实现从图纸识别到报价单生成的全流程自动化。

### 1.2 核心功能
- **图纸OCR识别**：基于Ollama + Qwen3-VL实现图纸自动识别
- **信息提取**：自动提取尺寸、材质、公差、工艺要求等
- **智能报价**：基于工艺库和报价公式自动计算
- **报价单生成**：一键生成专业报价单（PDF/Excel）

---

## 2. 技术栈选型

### 2.1 后端技术栈
```
- 框架：FastAPI（高性能、异步、类型提示）
- 数据库：PostgreSQL / SQLite（开发）
- ORM：SQLAlchemy 2.0
- OCR引擎：Ollama + qwen3-vl:7b（本地Vision模型）
- 任务队列：Celery + Redis（处理长时间OCR任务）
- 数据验证：Pydantic V2
```

### 2.2 前端技术栈
```
- 框架：React 18
- UI库：Ant Design 5.x
- 状态管理：Zustand / React Query
- 图纸预览：PDF.js / react-pdf
- 表单处理：React Hook Form
```

### 2.3 开发工具
```
- 包管理：npm/yarn (前端), pip/poetry (后端)
- 代码规范：ESLint, Black, isort
- 版本控制：Git
- 部署：Windows开发 + WSL生产环境
```

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ 图纸上传   │  │ 信息编辑     │  │ 报价单生成      │     │
│  └────────────┘  └──────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      React前端应用                            │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ 图纸管理   │  │ 工艺配置     │  │ 报价历史        │     │
│  └────────────┘  └──────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │ API请求
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      FastAPI后端                              │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ 认证授权   │  │ 图纸API      │  │ 报价API         │     │
│  └────────────┘  └──────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
         │                 │                    │
         ▼                 ▼                    ▼
┌─────────────┐  ┌─────────────────┐  ┌───────────────────┐
│             │  │                 │  │                   │
│ PostgreSQL  │  │ Ollama Vision   │  │ 报价公式引擎      │
│ 数据库      │  │ OCR服务         │  │                   │
│             │  │ (qwen3-vl)      │  │ Excel公式解析     │
└─────────────┘  └─────────────────┘  └───────────────────┘
```

### 3.2 核心模块

#### 3.2.1 OCR识别模块
```python
服务：DrawingOCRService
功能：
  - 上传图纸（PDF/图片）
  - 调用Ollama Vision API
  - 提取关键信息（尺寸、材质、公差）
  - 结构化存储
依赖：
  - invoice_ocr_service.py（参考采购系统）
  - Ollama本地服务（http://localhost:11434）
```

#### 3.2.2 工艺库模块
```python
数据表：
  - materials（材料库）：材质、密度、硬度、价格
  - processes（工艺库）：车、铣、磨、钻等工艺参数
  - machines（设备库）：设备类型、工时定额
  - cutting_params（切削参数）：不同材质的切削速度、进给量

功能：
  - 材料查询和管理
  - 工艺参数配置
  - 工艺路线推荐
```

#### 3.2.3 报价计算引擎
```python
服务：QuoteCalculationService
功能：
  - 解析Excel报价公式（创怡兴tab）
  - 材料成本计算
  - 加工成本计算（基于工艺库）
  - 管理费、利润率计算
  - 生成明细清单
```

#### 3.2.4 报价单生成模块
```python
服务：QuoteDocumentService
功能：
  - 生成PDF报价单（ReportLab / WeasyPrint）
  - 生成Excel报价单（openpyxl）
  - 支持自定义模板
  - 电子签章（可选）
```

---

## 4. 数据库设计

### 4.1 核心表结构

```sql
-- 图纸表
CREATE TABLE drawings (
    id SERIAL PRIMARY KEY,
    drawing_number VARCHAR(100) UNIQUE NOT NULL,
    customer_name VARCHAR(200),
    product_name VARCHAR(200),
    material VARCHAR(100),
    file_path VARCHAR(500),
    ocr_data JSONB,  -- OCR识别的原始数据
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 材料库
CREATE TABLE materials (
    id SERIAL PRIMARY KEY,
    material_code VARCHAR(50) UNIQUE,
    material_name VARCHAR(100),
    category VARCHAR(50),  -- 不锈钢、铝合金、铜合金等
    density DECIMAL(10,4),  -- 密度 g/cm³
    hardness VARCHAR(50),   -- 硬度
    price_per_kg DECIMAL(10,2),  -- 价格/kg
    supplier VARCHAR(200),
    remark TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 工艺库
CREATE TABLE processes (
    id SERIAL PRIMARY KEY,
    process_code VARCHAR(50) UNIQUE,
    process_name VARCHAR(100),  -- CNC车削、铣削、磨削等
    category VARCHAR(50),       -- 车削、铣削、磨削、钻孔
    machine_type VARCHAR(100),  -- 设备类型
    hourly_rate DECIMAL(10,2),  -- 工时费率（元/小时）
    setup_time DECIMAL(10,2),   -- 装夹时间（小时）
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 切削参数库
CREATE TABLE cutting_parameters (
    id SERIAL PRIMARY KEY,
    material_category VARCHAR(50),  -- 材料类别
    process_type VARCHAR(50),       -- 工艺类型
    cutting_speed DECIMAL(10,2),    -- 切削速度 m/min
    feed_rate DECIMAL(10,4),        -- 进给量 mm/r
    depth_of_cut DECIMAL(10,2),     -- 切削深度 mm
    tool_life INTEGER,              -- 刀具寿命（分钟）
    remark TEXT
);

-- 报价记录表
CREATE TABLE quotes (
    id SERIAL PRIMARY KEY,
    quote_number VARCHAR(100) UNIQUE,
    drawing_id INTEGER REFERENCES drawings(id),
    customer_name VARCHAR(200),
    total_amount DECIMAL(12,2),
    currency VARCHAR(10) DEFAULT 'CNY',
    status VARCHAR(20),  -- draft, sent, approved, rejected
    details JSONB,       -- 报价明细
    created_by INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    valid_until DATE
);

-- 工艺路线表
CREATE TABLE process_routes (
    id SERIAL PRIMARY KEY,
    drawing_id INTEGER REFERENCES drawings(id),
    sequence_number INTEGER,
    process_id INTEGER REFERENCES processes(id),
    estimated_time DECIMAL(10,4),  -- 预估加工时间（小时）
    cost DECIMAL(10,2),            -- 该工序成本
    remark TEXT
);
```

---

## 5. 核心API设计

### 5.1 图纸管理API

```
POST   /api/drawings/upload              上传图纸
POST   /api/drawings/{id}/ocr            触发OCR识别
GET    /api/drawings/{id}                获取图纸详情
PUT    /api/drawings/{id}                更新图纸信息
GET    /api/drawings                     图纸列表
DELETE /api/drawings/{id}                删除图纸
```

### 5.2 工艺库API

```
GET    /api/materials                    材料列表
POST   /api/materials                    添加材料
GET    /api/materials/search?q={query}   搜索材料

GET    /api/processes                    工艺列表
POST   /api/processes                    添加工艺
GET    /api/processes/recommend          推荐工艺路线

GET    /api/cutting-params               切削参数查询
```

### 5.3 报价API

```
POST   /api/quotes/calculate             计算报价
GET    /api/quotes/{id}                  获取报价详情
POST   /api/quotes/{id}/generate-pdf     生成PDF报价单
POST   /api/quotes/{id}/generate-excel   生成Excel报价单
GET    /api/quotes                       报价列表
PUT    /api/quotes/{id}/status           更新报价状态
```

---

## 6. 报价公式解析

### 6.1 基于Excel公式（创怡兴tab）

从Excel中提取的核心公式：
```
总价 = 材料费 + 加工费 + 管理费 + 其他费用 + 利润

其中：
- 材料费(B) = 重量(E) × 材料单价 × (1 + 总不良率) × (1 + 材管率)
- 重量(E) = π × (外径²/4) × 材料长度 ÷ 取数 × 比重
- 加工费(C) = Σ(各工序加工费)
- 工序加工费 = [(加工个数 ÷ 日产 + 段取时间) × 工事费/日] ÷ LOT
- 管理费(D) = 小计单价 × 管理费率（约4.5%）
- 利润(M) = 小计单价 × 利润率（15%）
- 其他费用(F) = 梱包材料 + 消耗品 + 电镀费等
```

### 6.2 计算引擎实现策略

```python
class QuoteCalculator:
    def __init__(self, formula_config):
        self.config = formula_config  # 从Excel加载的配置

    def calculate_material_cost(self, drawing_info):
        """计算材料成本"""
        # 获取材料密度、价格
        # 计算重量
        # 考虑不良率、材管率
        pass

    def calculate_process_cost(self, process_route):
        """计算加工成本"""
        # 遍历工艺路线
        # 查询工时定额
        # 计算各工序成本
        pass

    def calculate_total(self, material_cost, process_cost):
        """计算总价"""
        # 加上管理费、利润
        pass
```

---

## 7. 前端界面设计

### 7.1 主要页面

```
1. 图纸上传页面
   - 拖拽上传
   - 图纸预览
   - 一键OCR识别
   - 识别进度显示

2. 信息编辑页面
   - 表单编辑（尺寸、材质、公差）
   - 工艺选择
   - 参数调整
   - 实时预览报价

3. 工艺配置页面
   - 工艺路线拖拽排序
   - 工艺参数设置
   - 智能推荐

4. 报价单页面
   - 报价明细展示
   - 成本分析图表
   - 一键生成PDF/Excel
   - 历史报价查询

5. 基础数据管理
   - 材料库管理
   - 工艺库管理
   - 设备库管理
```

---

## 8. 开源数据库集成

### 8.1 推荐的开源资源

```
1. 材料数据库
   - MatWeb (https://www.matweb.com/) - 爬取
   - CES EduPack开源数据
   - 中国材料数据手册

2. 机加工工艺数据
   - Machinery's Handbook数据
   - 切削参数手册
   - 国家标准工时定额

3. 初始化数据
   - 常见不锈钢材质（304、316、303等）
   - 常见铝合金（6061、7075等）
   - 常见加工工艺参数
```

### 8.2 数据导入策略

```python
# 初始化脚本
def init_material_database():
    """导入材料数据"""
    materials = [
        {
            "code": "SUS303",
            "name": "303不锈钢",
            "density": 7.93,
            "price_per_kg": 35.0
        },
        # ... 更多材料
    ]

def init_process_database():
    """导入工艺数据"""
    processes = [
        {
            "code": "CNC_TURNING",
            "name": "CNC车削",
            "hourly_rate": 55.0,
            "setup_time": 0.125
        },
        # ... 更多工艺
    ]
```

---

## 9. 部署方案

### 9.1 开发环境（Windows）
```bash
# 后端
cd backend
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
uvicorn main:app --reload

# 前端
cd frontend
npm install
npm start

# Ollama
ollama serve
ollama pull qwen3-vl:7b
```

### 9.2 生产环境（WSL）
```bash
# Docker Compose部署
docker-compose up -d

# 服务包括：
- FastAPI后端
- PostgreSQL数据库
- Redis缓存
- Nginx反向代理
- Ollama服务
```

---

## 10. 开发路线图

### Phase 1: 基础框架（1-2周）
- ✅ 搭建后端FastAPI框架
- ✅ 搭建前端React框架
- ✅ 数据库设计和初始化
- ✅ 基础认证功能

### Phase 2: OCR识别（1周）
- ✅ 集成Ollama Vision
- ✅ 图纸上传和预览
- ✅ OCR信息提取
- ✅ 信息编辑界面

### Phase 3: 工艺库（1周）
- ✅ 材料库CRUD
- ✅ 工艺库CRUD
- ✅ 切削参数管理
- ✅ 数据导入脚本

### Phase 4: 报价引擎（1-2周）
- ✅ Excel公式解析
- ✅ 报价计算逻辑
- ✅ 成本分析
- ✅ 报价单生成

### Phase 5: 优化和测试（1周）
- ✅ 性能优化
- ✅ 用户体验优化
- ✅ 测试和修复
- ✅ 文档完善

---

## 11. 技术难点和解决方案

### 11.1 图纸OCR准确率
**问题**：工程图纸复杂，尺寸标注多样
**解决**：
- 使用高性能Vision模型（Qwen3-VL）
- 提供人工校对界面
- 建立图纸模板库

### 11.2 报价公式复杂性
**问题**：Excel公式复杂，包含多重嵌套
**解决**：
- 使用openpyxl解析Excel公式
- 建立公式AST（抽象语法树）
- 分步计算，可追溯

### 11.3 工艺路线推荐
**问题**：不同零件需要不同工艺
**解决**：
- 建立规则引擎
- 基于历史数据推荐
- 支持人工调整

---

## 12. 参考资料

- FastAPI官方文档：https://fastapi.tiangolo.com/
- Ollama API文档：https://github.com/ollama/ollama/blob/main/docs/api.md
- SQLAlchemy 2.0文档：https://docs.sqlalchemy.org/
- Ant Design文档：https://ant.design/
- 采购系统OCR实现：`C:\Users\Admin\Desktop\采购\backend\services\invoice_ocr_service.py`
