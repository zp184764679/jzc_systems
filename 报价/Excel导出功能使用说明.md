# 📊 晨龙精密报价单导出功能使用说明

## ✅ 功能概述

系统已成功整合"晨龙精密报价单"Excel模板，支持批量导出多个产品的报价单。

### 主要特性

- ✅ 批量选择图纸导出
- ✅ 使用标准晨龙精密报价单模板
- ✅ 自动填充产品信息（图号、尺寸、材质、表面处理等）
- ✅ 支持自定义客户信息和报价单号
- ✅ 最多支持12个产品同时导出

---

## 📖 使用步骤

### 1. 进入图纸列表页面
访问：http://localhost:8000/drawings

### 2. 上传并识别图纸
1. 点击"上传图纸"按钮
2. 选择PDF图纸文件
3. 等待OCR自动识别完成（状态变为"已完成"）

### 3. 选择要导出的图纸
- 在图纸列表中勾选需要导出的图纸（复选框）
- **注意**：只有OCR识别完成的图纸才能被选中
- 页面顶部会显示已选择的数量：`导出报价单 (N)`

### 4. 配置导出信息
点击"导出报价单"按钮后，填写以下信息：

| 字段 | 说明 | 是否必填 | 默认值 |
|------|------|----------|--------|
| 客户名称 | 报价单抬头的客户公司名 | ✅ 必填 | 深圳市晨龙精密五金制品有限公司 |
| 联系人 | 客户联系人姓名 | ✅ 必填 | 郭先生 |
| 电话 | 客户联系电话 | 可选 | - |
| 传真 | 客户传真号码 | 可选 | - |
| 报价单号 | 报价单编号 | ✅ 必填 | 自动生成（如：251114） |
| 默认批量 | 产品最小订购量 | ✅ 必填 | 1000 |

### 5. 导出Excel文件
点击"导出"按钮，系统会：
1. 生成Excel文件
2. 自动下载到本地
3. 文件名格式：`晨龙精密报价单_报价单号.xls`

---

## 📋 Excel模板字段映射

### 头部信息
| Excel位置 | 字段来源 | 示例 |
|-----------|----------|------|
| 行5, 列0 | customer_name | TO：深圳市晨龙精密五金制品有限公司 |
| 行5, 列7 | quote_date | 日期：2025-11-14 |
| 行6, 列0 | contact_person | ATTN：郭先生 |
| 行6, 列7 | phone | 电话：139xxxx |
| 行7, 列0 | quote_number | 报价单号：251114 |
| 行7, 列7 | fax | 传真：0755-xxxx |

### 产品明细（从第10行开始）
| 列号 | 字段名 | 数据来源 | 示例 |
|------|--------|----------|------|
| 列0 | 序号 | 自动编号 | 1.0, 2.0... |
| 列1 | 部品番号 | drawing_number/customer_part_number | 8001-0003095 |
| 列2 | 直径(MM) | outer_diameter | 7.8 |
| 列3 | 长度(MM) | length | 240.4 |
| 列4 | 材质 | material | SUS303 |
| 列5 | 处理 | surface_treatment | 无电解镍/脱脂 |
| 列6 | MOQ | lot_size/默认批量 | 1000 |
| 列7 | 未税单价 | unit_price_before_tax | 0.3928 |
| 列8 | 含税单价 | unit_price_with_tax | 0.4439 |
| 列9 | 备注 | notes | - |

---

## 🔍 数据来源说明

### 自动从图纸OCR识别获取
- ✅ 图号（drawing_number）
- ✅ 客户料号（customer_part_number）
- ✅ 外径（outer_diameter）
- ✅ 长度（length）
- ✅ 材质（material）
- ✅ 表面处理（surface_treatment）

### 从报价单获取（如果已创建报价）
- ✅ 未税单价（unit_price_before_tax）
- ✅ 含税单价（unit_price_with_tax）
- ✅ 批量（lot_size）

**注意**：如果图纸没有关联的报价单，价格字段将为空，需要手动填写。

### 用户手动输入
- ✅ 客户名称
- ✅ 联系人
- ✅ 电话/传真
- ✅ 报价单号
- ✅ 默认批量

---

## 💡 使用技巧

### 1. 批量导出工作流
```
图纸上传 → OCR识别 → [可选]创建报价 → 批量选择 → 配置导出 → 下载Excel
```

### 2. 如何获取准确价格
如果想要Excel中自动包含价格信息：
1. 先为每个图纸创建报价（点击"报价"按钮）
2. 系统会在导出时自动使用最新的报价数据
3. 价格会自动计算含税单价（13%税率）

### 3. 批量选择技巧
- 可以跨页选择图纸
- 已选择的图纸数量会实时显示在按钮上
- 取消勾选会从已选列表中移除

### 4. 报价单号命名建议
```
格式：YYMMDD  （年月日）
示例：251114  （2025年11月14日）
```

---

## ⚠️ 注意事项

### 限制说明
1. **最多12个产品**：单次导出最多支持12个产品（模板限制）
2. **必须完成OCR识别**：只有OCR状态为"已完成"的图纸才能导出
3. **文件格式**：导出的是.xls格式（Excel 2003兼容）

### 常见问题

**Q1：为什么有些图纸无法勾选？**
A：只有OCR识别完成的图纸才能勾选。请先点击"识别"按钮完成OCR识别。

**Q2：导出的Excel中没有价格？**
A：需要先为图纸创建报价。或者导出后在Excel中手动填写价格。

**Q3：可以修改Excel模板吗？**
A：可以修改 `backend/templates/quote_template.xls` 文件，系统会使用更新后的模板。

**Q4：导出失败怎么办？**
A：检查：
- 后端服务是否正常运行
- 选择的图纸是否都已完成OCR识别
- 浏览器控制台是否有错误信息

---

## 🔧 技术架构

### 后端
- **模板路径**：`backend/templates/quote_template.xls`
- **导出服务**：`backend/services/quote_document_generator.py`
  - 方法：`generate_chenlong_template()`
- **API端点**：`POST /api/quotes/export/chenlong-template`

### 前端
- **页面**：`frontend/src/pages/DrawingList.jsx`
- **API调用**：`frontend/src/services/api.js`
  - 函数：`exportChenlongTemplate()`

### 数据流
```
前端选择图纸
  ↓
填写客户信息
  ↓
发送drawing_ids到后端
  ↓
后端查询图纸详情
  ↓
填充Excel模板
  ↓
返回.xls文件流
  ↓
前端触发下载
```

---

## 📞 支持

如遇到问题，请检查：
1. 后端日志：查看 backend 控制台输出
2. 前端控制台：查看浏览器 Console 错误信息
3. 网络请求：查看 Network 标签页的 API 调用情况

---

**最后更新时间**：2025-11-14
**功能版本**：v1.0
**支持的产品数量**：1-12个
