# 📊 报价系统界面重构总结

## ✅ 完成时间
**2025-11-14**

---

## 🎯 重构目标

按照Excel报价公式的费用分类，系统性地重构工程师工作台界面，使其：
1. 清晰展示B、C、D、F、M各项费用的计算参数
2. 每个费用分类独立成区，右上角显示计算结果
3. 参数全部可编辑，方便工程师调试
4. 最终汇总显示A小计、N单价、总金额

---

## 📋 重构后的界面结构

```
┌─────────────────────────────────────────────┐
│  📋 基本信息（图号、客户、材质...）          │
├─────────────────────────────────────────────┤
│  🔧 B 材料费计算参数            B = ??.?? 元 │
│  ├─ 材料长度、产品长、切口、残材            │
│  ├─ 材料单价、材料密度                      │
│  └─ 总不良率、材管率                        │
│     实时显示：取数: ?? | 重量: ?? g         │
├─────────────────────────────────────────────┤
│  ⚙️ C 加工费计算参数            C = ??.?? 元 │
│  ├─ 工序选择网格（8个常用工艺）             │
│  └─ 工序明细表（可编辑）                    │
│     不良率、日产、段取时间、工事费/日       │
├─────────────────────────────────────────────┤
│  📊 D 管理费计算参数            D = ??.?? 元 │
│  ├─ 一般管理费 = C × 管理费率%              │
│  └─ H运送费 = 基础运费 ÷ 参数1 ÷ 参数2 ÷ 参数3 │
├─────────────────────────────────────────────┤
│  📦 F 其他费用      │  💰 M 利润             │
│  F = ??.?? 元       │  M = ??.?? 元          │
│  包装材料费          │  M = A × 利润率%       │
│  消耗品费            │                        │
├─────────────────────────────────────────────┤
│  🎯 报价结果汇总                             │
│  A 小计单价 = B+C+D+F = ??.?? 元            │
│  M 利润 = A × 15% = ??.?? 元                │
│  N 单价 = A+M = ??.?? 元/件                 │
│  总金额 = N × 批量 = ??.?? 元               │
├─────────────────────────────────────────────┤
│            [一键报价]按钮                    │
└─────────────────────────────────────────────┘
```

---

## 🔧 B 材料费参数

### 新增字段
| 字段 | 说明 | 默认值 | 单位 |
|------|------|--------|------|
| material_length | 材料长度 | 2500 | mm |
| product_length | 产品长 | 从OCR识别 | mm |
| cut_width | 切口 | 2.5 | mm |
| remaining_material | 残材 | 160 | mm |
| material_price | 材料单价 | 5.1 | 元/kg |
| material_density | 材料密度 | 0.0079 | g/cm³ |
| material_mgmt_rate | 材管率 | 3 | % |
| total_defect_rate | 总不良率 | 3.06 | % |

### 计算公式
```
取数 = Int[(材料长度 - 残材) / (产品长 + 切口)]
重量(g) = π × (外径)²/4 × 材料长度 ÷ 取数 × 比重
B材料费 = 重量 × 材料单价 × (1+总不良率%) × (1+材管率%) ÷ 1000
```

---

## ⚙️ C 加工费参数

### 工序明细表（可编辑）
每个工序有以下可编辑参数：
- defect_rate (不良率%)
- daily_output (日产)
- setup_time (段取时间)
- daily_fee (工事费/日)

### 计算公式
```
加工个数 = LOT × (1 + 不良率/100)
加工日数 = 加工个数 ÷ 日产
加工小费 = (加工日数 + 段取时间) × 工事费/日 ÷ LOT
C加工费 = Σ(所有工序的加工小费)
```

---

## 📊 D 管理费参数

### 新增字段
| 字段 | 说明 | 默认值 |
|------|------|--------|
| management_rate | 管理费率 | 10% |
| base_shipping_cost | 基础运费 | 200 |
| shipping_param1 | H运送费参数1 | 60 |
| shipping_param2 | H运送费参数2 | 80 |
| shipping_param3 | H运送费参数3 | 20 |

### 计算公式
```
一般管理费 = C加工费 × 管理费率%
H运送费 = 基础运费 ÷ 参数1 ÷ 参数2 ÷ 参数3
         = 200 ÷ 60 ÷ 80 ÷ 20
         = 0.00208 元/件
D管理费 = 一般管理费 + H运送费
```

---

## 📦 F 其他费用参数

### 字段
| 字段 | 说明 | 默认值 |
|------|------|--------|
| packaging_cost | 包装材料费 | 0.316 元/件 |
| consumables_cost | 消耗品费 | 0.006 元/件 |

### 计算公式
```
F其他费用 = 包装材料费 + 消耗品费
         = 0.316 + 0.006
         = 0.322 元/件
```

---

## 💰 M 利润参数

### 字段
| 字段 | 说明 | 默认值 |
|------|------|--------|
| profit_rate | 利润率 | 15% |

### 计算公式
```
M利润 = A小计单价 × 利润率%
```

---

## 🎯 最终报价汇总

### 显示内容
```
A 小计单价 = B + C + D + F = ??.?? 元
M 利润 = A × 利润率% = ??.?? 元
N 单价 = A + M = ??.?? 元/件
总金额 = N × 批量 = ??.?? 元
```

---

## 🎨 界面设计特点

### 1. 费用分类明确
每个费用类别（B、C、D、F、M）独立成Card，颜色标识：
- **B 材料费**：绿色 #52c41a
- **C 加工费**：蓝色 #1890ff
- **D 管理费**：橙色 #ff7a45
- **F 其他费用**：橙红色 #fa8c16
- **M 利润**：粉色 #eb2f96

### 2. 实时计算显示
每个Card的右上角（extra位置）显示计算结果：
```jsx
extra={<span style={{ fontSize: '12px', fontWeight: 600, color: '#52c41a' }}>B = ??.?? 元</span>}
```

### 3. 紧凑专业布局
- 字体：11-12px小字体
- 间距：8px紧凑间距
- 三列布局：充分利用水平空间
- Label宽度：labelCol={{ span: 10 }}

### 4. 公式说明
每个复杂计算区域都有公式说明文字，帮助工程师理解计算逻辑。

---

## 📊 参数对照表

### 参数总数统计
- **B 材料费参数**：8个
- **C 加工费参数**：每个工序4个（可动态添加）
- **D 管理费参数**：5个
- **F 其他费用参数**：2个
- **M 利润参数**：1个

**总计**：16个全局参数 + 工序明细参数

---

## 🔄 与Excel公式对应关系

| Excel字段 | 系统字段 | 位置 |
|-----------|----------|------|
| 外径 | outer_diameter | 基本信息-尺寸参数 |
| 材料長さ | material_length | B材料费-材料长度 |
| 製品長 | product_length | B材料费-产品长 |
| 切口 | cut_width | B材料费-切口 |
| 残材 | remaining_material | B材料费-残材 |
| 材料単价 | material_price | B材料费-材料单价 |
| 比重 | material_density | B材料费-材料密度 |
| 総不良率 | total_defect_rate | B材料费-总不良率 |
| 材管率 | material_mgmt_rate | B材料费-材管率 |
| 不良率 | defect_rate | C加工费-工序明细表 |
| 日産 | daily_output | C加工费-工序明细表 |
| 段取時間 | setup_time | C加工费-工序明细表 |
| 工事費／日 | daily_fee | C加工费-工序明细表 |
| 一般管理費率 | management_rate | D管理费-管理费率 |
| 運送費 | base_shipping_cost | D管理费-基础运费 |
| 箱 | shipping_param1 | D管理费-参数1 |
| 入数 | shipping_param2 | D管理费-参数2 |
| 積載率 | shipping_param3 | D管理费-参数3 |
| 梱包材料 | packaging_cost | F其他费用-包装材料费 |
| 消耗品 | consumables_cost | F其他费用-消耗品费 |
| 利润率 | profit_rate | M利润-利润率 |

---

## ✅ 重构完成的工作

1. ✅ 系统性分析Excel报价公式（报价公式完整分析.md）
2. ✅ 按B、C、D、F、M分类重构界面
3. ✅ 添加B材料费完整计算参数（8个字段）
4. ✅ 更新C加工费标题和显示
5. ✅ 添加D管理费参数卡片（含H运送费）
6. ✅ 添加F其他费用和M利润参数卡片
7. ✅ 添加报价结果汇总区
8. ✅ 更新表单初始值（所有新字段）
9. ✅ 修正运送费参数（3个除数参数）
10. ✅ 每个费用分类右上角显示计算结果（占位）

---

## 🔮 后续工作

### 下一步优化
1. **实时计算逻辑**：
   - 监听表单字段变化
   - 实时计算B、C、D、F、M各项费用
   - 更新extra中的显示值

2. **取数和重量计算**：
   - 根据材料长度、产品长、切口、残材计算取数
   - 根据外径、材料长度、比重、取数计算重量

3. **后端API对接**：
   - 将新增字段添加到后端schemas
   - 更新报价计算API
   - 保存和读取新字段

4. **表单验证**：
   - 必填字段验证
   - 数值范围验证
   - 公式计算验证

---

## 📝 技术亮点

1. **系统性分析**：先分析Excel完整公式结构，再重构界面
2. **费用分类清晰**：B、C、D、F、M分类明确，对应Excel结构
3. **参数完全可编辑**：所有计算参数都可由工程师调整
4. **公式透明化**：每个计算区域都展示公式，便于理解和调试
5. **紧凑专业**：信息密度高，适合专业工程师使用
6. **实时反馈**：每个分区显示计算结果（待实现实时计算）

---

**重构完成时间**：2025-11-14
**重构人员**：Claude Code
**界面版本**：v3.0 费用分类版
**设计理念**：Excel公式完全复刻，系统性重构，专业高效
