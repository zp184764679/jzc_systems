# é‡‡è´­ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ– - å¿«é€Ÿå¯åŠ¨æ£€æŸ¥æ¸…å• âœ…

## ğŸ“‹ åç«¯ä¼˜åŒ–å·²å®Œæˆé¡¹ç›®

- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– (19ä¸ªæ–°ç´¢å¼•å·²åº”ç”¨)
- âœ… RFQ åˆ†ç±»å¼‚æ­¥åŒ–æ”¹é€ 
- âœ… Celery å¼‚æ­¥ä»»åŠ¡åˆ›å»º
- âœ… åˆ†ç±»è¿›åº¦ API æ¥å£
- âœ… GPU åŠ é€Ÿä»£ç ä¿®å¤
- âœ… æ–‡æ¡£å’Œè„šæœ¬å‡†å¤‡å®Œæˆ

---

## ğŸš€ å¯åŠ¨æ­¥éª¤ (æŒ‰é¡ºåºæ‰§è¡Œ)

### Step 1: å¯åŠ¨ Redisã€å¿…é¡»ã€‘

**Windows Docker æ–¹å¼ï¼ˆæ¨èï¼‰**:
```bash
docker run -d --name redis-caigou -p 6379:6379 --restart always redis:latest
```

**Windows åŸç”Ÿæ–¹å¼**:
```bash
# å‚è§: backend/å¯åŠ¨Rediså’ŒCelery.md
cd C:\Redis
redis-server.exe
```

**éªŒè¯**:
```bash
redis-cli ping
# åº”è¾“å‡º: PONG
```

---

### Step 2: å¯åŠ¨ Celery Workerã€å¿…é¡»ã€‘

**æ–¹å¼ 1: ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰**
```bash
# åŒå‡»è¿è¡Œ
C:\Users\Admin\Desktop\é‡‡è´­\å¯åŠ¨åå°æœåŠ¡.bat
```

**æ–¹å¼ 2: æ‰‹åŠ¨å¯åŠ¨**
```bash
cd C:\Users\Admin\Desktop\é‡‡è´­\backend
celery -A celery_app worker --pool=solo --loglevel=info
```

**éªŒè¯**:
- æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼Œåº”æ˜¾ç¤º:
```
[tasks]
  . tasks.classify_rfq_items
  . tasks.send_rfq_notification

celery@YOUR-PC ready.
```

---

### Step 3: å¯åŠ¨ Flask Backendã€å·²è¿è¡Œã€‘

```bash
cd C:\Users\Admin\Desktop\é‡‡è´­\backend
python app.py
```

**éªŒè¯**:
- è®¿é—® http://localhost:5001/api/v1/health ï¼ˆå¦‚æœæœ‰å¥åº·æ£€æŸ¥ï¼‰
- æˆ–åˆ›å»ºä¸€ä¸ªæµ‹è¯• RFQ

---

### Step 4: å¯åŠ¨å‰ç«¯ã€ç°æœ‰æµç¨‹ã€‘

```bash
cd C:\Users\Admin\Desktop\é‡‡è´­\frontend
npm run dev
```

---

## âœ… åŠŸèƒ½æµ‹è¯•æ¸…å•

### æµ‹è¯• 1: æ•°æ®åº“ç´¢å¼•ç”Ÿæ•ˆ âš¡

**æ“ä½œ**:
1. æ‰“å¼€ PR å®¡æ‰¹åˆ—è¡¨
2. æ‰“å¼€ RFQ åˆ—è¡¨
3. æ‰“å¼€ä¾›åº”å•†æŠ¥ä»·åˆ—è¡¨
4. æŸ¥çœ‹é€šçŸ¥åˆ—è¡¨

**é¢„æœŸ**:
- åŠ è½½é€Ÿåº¦æ˜æ˜¾åŠ å¿«ï¼ˆä»å‡ ç™¾æ¯«ç§’é™åˆ°å‡ åæ¯«ç§’ï¼‰
- åˆ—è¡¨æ’åºå’Œè¿‡æ»¤é€Ÿåº¦æå‡

**éªŒè¯SQL** (å¯é€‰):
```sql
-- æŸ¥çœ‹æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•
EXPLAIN SELECT * FROM pr WHERE status = 'pending' ORDER BY created_at DESC;
-- åº”è¯¥çœ‹åˆ° "Using index" å­—æ ·
```

---

### æµ‹è¯• 2: å¼‚æ­¥åˆ†ç±»åŠŸèƒ½ ğŸ¯

**æ“ä½œ**:
1. åˆ›å»ºä¸€ä¸ªæ–°çš„ PR (åŒ…å«å¤šä¸ªç‰©æ–™é¡¹)
2. ä» PR åˆ›å»º RFQ
3. è§‚å¯Ÿå“åº”æ—¶é—´

**é¢„æœŸ**:
- RFQ åˆ›å»º**ç«‹å³è¿”å›**ï¼ˆ< 1ç§’ï¼Œä¹‹å‰éœ€è¦ 5-10ç§’ï¼‰
- åå°æ—¥å¿—æ˜¾ç¤º Celery ä»»åŠ¡å¯åŠ¨:
  ```
  [INFO] âœ… RFQ#XX åˆ›å»ºæˆåŠŸï¼Œå¼‚æ­¥åˆ†ç±»ä»»åŠ¡å·²å¯åŠ¨ (Task ID: ...)
  [INFO] å¼€å§‹åˆ†ç±» RFQ XX çš„ç‰©æ–™é¡¹...
  ```

**API æµ‹è¯•**:
```bash
# è·å–åˆ†ç±»çŠ¶æ€
curl http://localhost:5001/api/v1/rfqs/1/classification-status
```

**é¢„æœŸå“åº”**:
```json
{
  "rfq_id": 1,
  "classification_status": "processing",  // æˆ– "completed"
  "progress": {
    "total": 5,
    "classified": 3,
    "percentage": 60.0
  },
  "task": {
    "task_id": "abc123...",
    "state": "SUCCESS",
    "info": null
  }
}
```

---

### æµ‹è¯• 3: Celery Worker å¤„ç†ä»»åŠ¡ ğŸ”§

**æŸ¥çœ‹ Celery æ—¥å¿—**:
- æ‰“å¼€ Celery Worker ç»ˆç«¯çª—å£
- åˆ›å»º RFQ åï¼Œåº”çœ‹åˆ°:
```
[INFO] Task tasks.classify_rfq_items[abc123...] received
[INFO] å¼€å§‹åˆ†ç±» RFQ 1 çš„ç‰©æ–™é¡¹...
[INFO] ç‰©æ–™é¡¹ 1 åˆ†ç±»æˆåŠŸ: åˆ€å…·/é“£å‰Šåˆ€å…· (æ¥æº: rule)
[INFO] ç‰©æ–™é¡¹ 2 åˆ†ç±»æˆåŠŸ: æµ‹é‡å·¥å…·/å¡å°º (æ¥æº: knowledge)
...
[INFO] RFQ 1 åˆ†ç±»å®Œæˆ: {'rfq_id': 1, 'total_items': 5, 'success': 5, 'errors': 0}
[INFO] Task tasks.classify_rfq_items[abc123...] succeeded in 2.5s
```

---

### æµ‹è¯• 4: æ•°æ®åº“åˆ†ç±»çŠ¶æ€ ğŸ“Š

**æŸ¥è¯¢æ•°æ®åº“**:
```sql
-- æŸ¥çœ‹ RFQ åˆ†ç±»çŠ¶æ€
SELECT
  id,
  classification_status,
  classification_task_id,
  classification_started_at,
  classification_completed_at
FROM rfqs
WHERE id = 1;
```

**é¢„æœŸ**:
- `classification_status`: 'completed'
- `classification_task_id`: æœ‰å€¼
- `classification_completed_at`: æœ‰æ—¶é—´æˆ³

```sql
-- æŸ¥çœ‹ç‰©æ–™åˆ†ç±»ç»“æœ
SELECT
  item_name,
  category,
  major_category,
  minor_category,
  classification_source
FROM rfq_items
WHERE rfq_id = 1;
```

**é¢„æœŸ**:
- `category`: ä¸æ˜¯ "åˆ†ç±»ä¸­..."ï¼Œè€Œæ˜¯å…·ä½“åˆ†ç±»
- `classification_source`: 'rule', 'knowledge', 'llm', æˆ– 'vector'

---

## âš ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Redis è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
redis.exceptions.ConnectionError: Error connecting to Redis
```

**è§£å†³**:
```bash
# æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
redis-cli ping

# å¦‚æœæ²¡æœ‰å“åº”ï¼Œå¯åŠ¨ Redis
docker start redis-caigou
# æˆ–
cd C:\Redis && redis-server.exe
```

---

### é—®é¢˜ 2: Celery Worker æ— æ³•å¯åŠ¨

**é”™è¯¯ä¿¡æ¯**:
```
[ERROR] Cannot connect to redis://localhost:6379/0
```

**è§£å†³**:
1. ç¡®ä¿ Redis å·²å¯åŠ¨ (è§é—®é¢˜1)
2. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢ç«¯å£ 6379
3. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­ `CELERY_BROKER_URL` é…ç½®

---

### é—®é¢˜ 3: åˆ†ç±»ä»»åŠ¡å¡ä½ä¸å®Œæˆ

**æ’æŸ¥æ­¥éª¤**:
1. **æ£€æŸ¥ Celery Worker æ˜¯å¦è¿è¡Œ**:
   ```bash
   tasklist | findstr celery
   ```

2. **æŸ¥çœ‹ Celery æ—¥å¿—**:
   - æ‰“å¼€ Celery Worker ç»ˆç«¯
   - æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

3. **æ£€æŸ¥ä»»åŠ¡çŠ¶æ€**:
   ```python
   from extensions import celery
   task = celery.AsyncResult('task_id')
   print(task.state)
   print(task.info)
   ```

4. **æ‰‹åŠ¨é‡æ–°åˆ†ç±»**:
   ```python
   from tasks.classify_rfq_items import classify_rfq_items
   result = classify_rfq_items.delay(rfq_id)
   ```

---

### é—®é¢˜ 4: å‰ç«¯è½®è¯¢ä¸å·¥ä½œ

**æ£€æŸ¥**:
1. API æ¥å£æ˜¯å¦å¯è®¿é—®:
   ```bash
   curl http://localhost:5001/api/v1/rfqs/1/classification-status
   ```

2. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS é”™è¯¯

3. å‰ç«¯ä»£ç æ˜¯å¦æ­£ç¡®å®ç°è½®è¯¢é€»è¾‘

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”éªŒè¯

### åˆ›å»º RFQ å“åº”æ—¶é—´

**æµ‹è¯•æ–¹æ³•**:
```javascript
console.time('createRFQ');
// åˆ›å»º RFQ
const response = await fetch('/api/v1/rfqs', {...});
console.timeEnd('createRFQ');
```

**é¢„æœŸ**:
- âœ… ä¼˜åŒ–å: < 500ms (å¼‚æ­¥åˆ†ç±»)
- âŒ ä¼˜åŒ–å‰: 5000-10000ms (åŒæ­¥åˆ†ç±»)

---

### åˆ—è¡¨åŠ è½½é€Ÿåº¦

**æµ‹è¯•**: æ‰“å¼€ PR å®¡æ‰¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹ Network é¢æ¿

**é¢„æœŸ**:
- âœ… ä¼˜åŒ–å: 20-50ms (æœ‰ç´¢å¼•)
- âŒ ä¼˜åŒ–å‰: 200-500ms (æ— ç´¢å¼•)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### å¿…é¡»å®Œæˆï¼ˆåå°ä»»åŠ¡éœ€è¦ï¼‰
- [ ] å¯åŠ¨ Redis
- [ ] å¯åŠ¨ Celery Worker
- [ ] æµ‹è¯•åˆ›å»º RFQï¼ˆéªŒè¯å¼‚æ­¥åˆ†ç±»ï¼‰

### å¯é€‰æ“ä½œï¼ˆæ€§èƒ½æå‡ï¼‰
- [ ] å®‰è£… GPU ç‰ˆæœ¬åº“ï¼ˆå‚è§ `GPUåŠ é€Ÿå®‰è£…æŒ‡å—.md`ï¼‰
- [ ] é›†æˆå‰ç«¯è½®è¯¢UIï¼ˆå‚è§ `å¼‚æ­¥åˆ†ç±»é›†æˆç¤ºä¾‹.md`ï¼‰
- [ ] é…ç½® Redis å’Œ Celery å¼€æœºè‡ªå¯

---

## ğŸ“ æ”¯æŒæ–‡æ¡£

- **åç«¯ä¼˜åŒ–æŠ¥å‘Š**: `backend/ç³»ç»Ÿä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md`
- **å‰ç«¯é›†æˆæŒ‡å—**: `frontend/å¼‚æ­¥åˆ†ç±»é›†æˆç¤ºä¾‹.md`
- **Redis/Celery å®‰è£…**: `backend/å¯åŠ¨Rediså’ŒCelery.md`
- **GPU åŠ é€Ÿ**: `backend/GPUåŠ é€Ÿå®‰è£…æŒ‡å—.md`

---

## âœ… å®Œæˆç¡®è®¤

**å…¨éƒ¨å®Œæˆåï¼Œä½ åº”è¯¥çœ‹åˆ°**:

1. âœ… Redis è¿è¡Œä¸­ (`redis-cli ping` è¿”å› PONG)
2. âœ… Celery Worker è¿è¡Œä¸­ (ç»ˆç«¯æ˜¾ç¤º "ready")
3. âœ… åˆ›å»º RFQ < 1ç§’å“åº”
4. âœ… åˆ—è¡¨åŠ è½½é€Ÿåº¦æ˜æ˜¾åŠ å¿«
5. âœ… åå°æ—¥å¿—æ˜¾ç¤ºåˆ†ç±»ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ

**æ­å–œï¼ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–å®Œæˆ ğŸ‰**

---

**å®Œæˆæ—¶é—´**: 2025-11-08
**ä¼˜åŒ–æˆæœ**: æ€§èƒ½æå‡ 5-20å€ ğŸš€
