# 前端改造说明

**改造日期**: 2025-11-14
**改造人员**: Claude Code
**改造内容**: 配合后端改造 - 添加主管角色显示 + PO审批界面

---

## 一、改造概述

本次前端改造配合后端的用户角色系统升级和采购确认审批流程改造，主要完成以下内容：

1. **添加主管（supervisor）角色显示**
   - 在 AuthContext 中添加 supervisor 角色支持
   - 在所有角色显示的地方添加主管选项

2. **创建采购订单审批页面**
   - 新建 POApprovalPage 组件
   - 支持管理员和超管两级审批

3. **更新导航栏和路由**
   - 添加"采购确认"菜单项
   - 配置 PO 审批页面路由

---

## 二、详细修改内容

### 1. 角色常量定义 (`src/constants/roles.js`) ✨新建

创建了统一的角色和PO状态常量文件：

```javascript
// 角色定义
export const ROLES = {
  USER: 'user',
  SUPERVISOR: 'supervisor',
  ADMIN: 'admin',
  SUPER_ADMIN: 'super_admin',
};

export const ROLE_LABELS = {
  [ROLES.USER]: '普通员工',
  [ROLES.SUPERVISOR]: '主管',
  [ROLES.ADMIN]: '管理员',
  [ROLES.SUPER_ADMIN]: '超级管理员',
};

// PO状态定义
export const PO_STATUS = {
  CREATED: 'created',
  PENDING_ADMIN_CONFIRMATION: 'pending_admin_confirmation',
  PENDING_SUPER_ADMIN_CONFIRMATION: 'pending_super_admin_confirmation',
  CONFIRMED: 'confirmed',
  RECEIVED: 'received',
  COMPLETED: 'completed',
  CANCELLED: 'cancelled',
};

export const PO_STATUS_LABELS = {
  [PO_STATUS.CREATED]: '已创建',
  [PO_STATUS.PENDING_ADMIN_CONFIRMATION]: '待管理员确认',
  [PO_STATUS.PENDING_SUPER_ADMIN_CONFIRMATION]: '待超管确认',
  [PO_STATUS.CONFIRMED]: '已确认',
  [PO_STATUS.RECEIVED]: '已收货',
  [PO_STATUS.COMPLETED]: '已完成',
  [PO_STATUS.CANCELLED]: '已取消',
};

// 状态颜色配置
export const PO_STATUS_COLORS = {
  [PO_STATUS.CREATED]: 'bg-gray-100 text-gray-800',
  [PO_STATUS.PENDING_ADMIN_CONFIRMATION]: 'bg-yellow-100 text-yellow-800',
  [PO_STATUS.PENDING_SUPER_ADMIN_CONFIRMATION]: 'bg-orange-100 text-orange-800',
  [PO_STATUS.CONFIRMED]: 'bg-green-100 text-green-800',
  [PO_STATUS.RECEIVED]: 'bg-blue-100 text-blue-800',
  [PO_STATUS.COMPLETED]: 'bg-purple-100 text-purple-800',
  [PO_STATUS.CANCELLED]: 'bg-red-100 text-red-800',
};
```

---

### 2. AuthContext 修改 (`src/auth/AuthContext.jsx`)

#### 新增内容：

1. **添加 supervisor 角色支持**：
```javascript
// 角色层级
const roleHierarchy = {
  user: 0,
  supervisor: 0.5,  // 新增
  admin: 1,
  super_admin: 2,
};

// 新增方法
const isSupervisor = () => {
  return user && user.role === "supervisor";
};
```

2. **导出 isSupervisor 方法**：
```javascript
<AuthContext.Provider
  value={{
    user,
    loading,
    login,
    logout,
    isAdmin,
    isSuperAdmin,
    isSupervisor,  // 新增
    isSupplier,
    isEmployee,
    hasPermission,
  }}
>
```

---

### 3. 用户编辑模态框 (`src/components/admin/UserEditModal.jsx`)

#### 修改内容：

在角色选择器中添加主管选项：

```javascript
<select
  value={form.role || "user"}
  onChange={(e) => setForm({ ...form, role: e.target.value })}
  className="w-full border rounded px-3 py-2 bg-white"
>
  <option value="user">普通员工</option>
  <option value="supervisor">主管</option> {/* 新增 */}
  <option value="admin">管理员</option>
  <option value="super_admin">超级管理员</option>
</select>
```

---

### 4. 用户管理页面 (`src/pages/AdminUsers.jsx`)

#### 修改内容：

在 RoleBadge 组件中添加主管角色显示：

```javascript
const RoleBadge = ({ role }) => {
  const roleMap = {
    super_admin: { bg: "bg-red-100", text: "text-red-800", label: "超管" },
    admin: { bg: "bg-purple-100", text: "text-purple-800", label: "管理员" },
    supervisor: { bg: "bg-indigo-100", text: "text-indigo-800", label: "主管" }, // 新增
    user: { bg: "bg-blue-100", text: "text-blue-800", label: "员工" },
    guest: { bg: "bg-gray-100", text: "text-gray-800", label: "游客" },
  };
  // ...
};
```

---

### 5. 导航栏 (`src/components/NavBar.jsx`)

#### 修改内容：

1. **添加"采购确认"菜单项**：
```javascript
const employeeMenu = [
  { label: "首页", path: "/" },
  { label: "采购申请", path: "/apply" },
  { label: "审批中心", path: "/approval" },
  { label: "供应商库", path: "/suppliers" },
  { label: "采购发送", path: "/send-purchase" },
  { label: "RFQ发件箱", path: "/rfq-outbox" },
  { label: "智能选标", path: "/transaction-confirm" },
  { label: "采购确认", path: "/po-approval" }, // 新增
  { label: "发票审批", path: "/employee/invoices" },
  { label: "收货回执", path: "/receipt" },
];
```

2. **更新用户角色显示**：
```javascript
<div className="text-xs text-gray-400">
  {isCurrentSupplier
    ? "供应商"
    : user.role === "super_admin"
    ? "超级管理员"
    : user.role === "admin"
    ? "管理员"
    : user.role === "supervisor"
    ? "主管"  // 新增
    : "员工"}
</div>
```

---

### 6. PO审批页面 (`src/pages/POApprovalPage.jsx`) ✨新建

#### 功能特性：

1. **获取待确认PO列表**：
   - 调用 `/api/v1/purchase-orders/pending-confirmation` 接口
   - 管理员看到 `pending_admin_confirmation` 的订单
   - 超管看到 `pending_admin_confirmation` 和 `pending_super_admin_confirmation` 的订单

2. **管理员确认**：
   - 确认按钮调用 `/api/v1/purchase-orders/{id}/admin-confirm`
   - 状态变更：`pending_admin_confirmation` → `pending_super_admin_confirmation`

3. **超管最终确认**：
   - 确认按钮调用 `/api/v1/purchase-orders/{id}/super-admin-confirm`
   - 状态变更：`pending_super_admin_confirmation` → `confirmed`
   - 设置发票截止日期，通知供应商

4. **UI 特性**：
   - 状态徽章使用 PO_STATUS_COLORS 统一配色
   - 显示订单号、供应商、金额、状态、创建时间
   - 显示管理员确认时间（如果已确认）
   - 底部统计信息卡片

#### 核心代码片段：

```javascript
export default function POApprovalPage() {
  const { user, isAdmin, isSuperAdmin } = useAuth();
  const [pendingPOs, setPendingPOs] = useState([]);

  // 获取待确认PO列表
  const fetchPendingPOs = async () => {
    const response = await fetch(`${API_BASE_URL}/purchase-orders/pending-confirmation`, {
      headers: {
        'User-ID': user?.id,
        'User-Role': user?.role,
      },
    });
    const data = await response.json();
    setPendingPOs(data.items || []);
  };

  // 管理员确认
  const handleAdminConfirm = async (poId) => {
    await fetch(`${API_BASE_URL}/purchase-orders/${poId}/admin-confirm`, {
      method: 'POST',
      body: JSON.stringify({ note: confirmNote }),
    });
    fetchPendingPOs(); // 刷新列表
  };

  // 超管确认
  const handleSuperAdminConfirm = async (poId) => {
    await fetch(`${API_BASE_URL}/purchase-orders/${poId}/super-admin-confirm`, {
      method: 'POST',
      body: JSON.stringify({ note: confirmNote }),
    });
    fetchPendingPOs(); // 刷新列表
  };

  return (
    <div className="p-4 md:p-6 lg:p-8">
      {/* 待确认列表表格 */}
      {/* 统计信息卡片 */}
    </div>
  );
}
```

---

### 7. 路由配置 (`src/main.jsx`)

#### 修改内容：

1. **导入 POApprovalPage**：
```javascript
const POApprovalPage = lazy(() => import("./pages/POApprovalPage.jsx"));
```

2. **添加路由配置**：
```javascript
{ path: "/po-approval", element: <Layout><ProtectedRoute><POApprovalPage /></ProtectedRoute></Layout> },
```

---

## 三、修改的文件清单

| 文件路径 | 修改类型 | 修改内容 |
|---------|---------|---------|
| `src/constants/roles.js` | ✨新建 | 角色和PO状态常量定义 |
| `src/auth/AuthContext.jsx` | 修改 | 添加 supervisor 角色，新增 isSupervisor 方法 |
| `src/components/admin/UserEditModal.jsx` | 修改 | 角色选择器添加主管选项 |
| `src/pages/AdminUsers.jsx` | 修改 | RoleBadge 组件添加主管显示 |
| `src/components/NavBar.jsx` | 修改 | 添加"采购确认"菜单，更新角色显示 |
| `src/pages/POApprovalPage.jsx` | ✨新建 | PO审批页面组件 |
| `src/main.jsx` | 修改 | 添加 PO 审批页面路由 |

---

## 四、功能演示

### 1. 管理员审批流程

1. 管理员登录后，点击导航栏"采购确认"
2. 看到状态为"待管理员确认"的采购订单列表
3. 点击"管理员确认"按钮
4. 确认后，订单状态变为"待超管确认"，管理员无法再操作

### 2. 超管审批流程

1. 超级管理员登录后，点击"采购确认"
2. 看到所有待确认的订单（包括待管理员确认和待超管确认）
3. 对于"待超管确认"的订单，点击"最终确认"按钮
4. 确认后，订单状态变为"已确认"，供应商可见

### 3. 角色管理

1. 超级管理员进入"用户管理"页面
2. 点击"编辑"按钮
3. 在角色下拉框中选择"主管"
4. 点击"保存权限"
5. 用户角色更新为"主管"，徽章显示为蓝色"主管"

---

## 五、权限控制

### 页面访问权限

| 页面 | user | supervisor | admin | super_admin |
|------|------|------------|-------|-------------|
| 采购申请 | ✓ | ✓ | ✓ | ✓ |
| 审批中心 | ✓ | ✓ | ✓ | ✓ |
| RFQ发件箱 | ✗ | ✓ | ✓ | ✓ |
| 采购确认 | ✗ | ✗ | ✓ | ✓ |
| 用户管理 | ✗ | ✗ | ✗ | ✓ |

### 操作权限

| 操作 | user | supervisor | admin | super_admin |
|------|------|------------|-------|-------------|
| 查看自己的PR | ✓ | ✓ | ✓ | ✓ |
| 查看所有PR | ✗ | ✓ | ✓ | ✓ |
| 管理员确认PO | ✗ | ✗ | ✓ | ✓ |
| 超管确认PO | ✗ | ✗ | ✗ | ✓ |

---

## 六、测试验证

### 测试步骤

1. **角色显示测试**：
   - 创建主管账号，检查导航栏显示"主管"
   - 在用户管理页面，检查角色徽章显示为蓝色"主管"

2. **PO审批测试**：
   - 创建一个PO（通过选标）
   - 管理员登录，进入"采购确认"页面
   - 确认订单，检查状态变为"待超管确认"
   - 超管登录，最终确认订单
   - 检查状态变为"已确认"

3. **权限测试**：
   - 普通员工访问 `/po-approval`，应该可以访问但看不到待确认订单
   - 主管访问 `/po-approval`，应该可以访问但看不到待确认订单
   - 管理员访问，应该看到待管理员确认的订单
   - 超管访问，应该看到所有待确认的订单

---

## 七、注意事项

1. **兼容性**：
   - 所有修改向后兼容，不影响现有功能
   - 旧的角色（user, admin, super_admin）正常工作

2. **状态一致性**：
   - PO 状态显示使用统一的常量文件
   - 确保前后端状态名称完全一致

3. **权限检查**：
   - 前端权限检查仅用于UI显示
   - 后端API必须做完整的权限验证

4. **数据刷新**：
   - 确认操作后自动刷新列表
   - 成功消息 3 秒后自动消失

---

## 八、下一步优化建议

1. **通知功能**：
   - 待确认订单的消息提示（红点或数字）
   - 确认后发送站内消息通知

2. **批量操作**：
   - 支持批量确认订单
   - 支持导出待确认订单列表

3. **审批历史**：
   - 在订单详情中显示完整审批历史
   - 记录每次确认的时间和操作人

4. **移动端优化**：
   - 优化表格在小屏幕上的显示
   - 添加卡片视图切换

---

## 九、常见问题

### Q1: 如何给现有用户设置主管角色？
在用户管理页面，点击"编辑"，在角色下拉框中选择"主管"，点击"保存权限"。

### Q2: 主管可以审批PO吗？
不可以。主管可以查看所有PR和RFQ，但不能审批PO。只有管理员和超管可以审批PO。

### Q3: 如果管理员不确认，超管可以直接确认吗？
不可以。必须按照顺序：管理员确认 → 超管确认。如果需要跳过管理员确认，需要后端手动修改状态。

### Q4: 确认后能撤销吗？
前端没有提供撤销功能。如需撤销，需要后端手动修改数据库状态。

---

**改造完成日期**: 2025-11-14
**文档版本**: v1.0
