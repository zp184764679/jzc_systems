// src/pages/TransactionConfirmPage.jsx
// äº¤æ˜“ç¡®è®¤ï¼ˆé€‰ä¸­æ ‡ï¼‰é¡µé¢ - æ™ºèƒ½åŒ–é‡‡è´­å†³ç­–æ”¯æŒç³»ç»Ÿ
import React, { useState, useEffect } from "react";
import { api } from "../api/http";
import { ENDPOINTS } from "../api/endpoints";

// æ™ºèƒ½æ¨èæ ‡ç­¾ç»„ä»¶
function RecommendationBadge({ type, text }) {
  const styles = {
    best: "bg-gradient-to-r from-green-500 to-green-600 text-white",
    good: "bg-gradient-to-r from-blue-500 to-blue-600 text-white",
    warning: "bg-gradient-to-r from-orange-500 to-orange-600 text-white",
  };

  return (
    <span className={`px-3 py-1 rounded-full text-xs font-bold ${styles[type]} shadow-sm`}>
      {text}
    </span>
  );
}

// RFQè¯¦æƒ…æ¨¡æ€æ¡† - æ™ºèƒ½å¯¹æ¯”å’Œæ¨è
function RFQDetailModal({ rfq, onClose, onSelectWinner }) {
  const [selectedSuppliers, setSelectedSuppliers] = useState(new Set());
  const [loadingCreate, setLoadingCreate] = useState(false);
  const [autoRecommend, setAutoRecommend] = useState(true);

  if (!rfq) return null;

  // æŒ‰ç‰©æ–™åˆ†ç»„çš„æŠ¥ä»·
  const quotesByItem = {};
  (rfq.quotes || []).forEach(quote => {
    const itemKey = quote.item_name || `ç‰©æ–™-${quote.rfq_item_id}`;
    if (!quotesByItem[itemKey]) {
      quotesByItem[itemKey] = {
        name: itemKey,
        quotes: [],
      };
    }
    quotesByItem[itemKey].quotes.push(quote);
  });

  // æŒ‰ä¾›åº”å•†åˆ†ç»„çš„æŠ¥ä»·ï¼ˆæ™ºèƒ½é€‰æ ‡ç”¨ï¼‰
  const quotesBySupplier = {};
  (rfq.quotes || []).forEach(quote => {
    const supplierId = quote.supplier_id;
    if (!quotesBySupplier[supplierId]) {
      quotesBySupplier[supplierId] = {
        supplier_id: supplierId,
        supplier_name: quote.supplier_name || `ä¾›åº”å•† #${supplierId}`,
        items: [],
        total_price: 0,
        lead_time: null,
        payment_terms: null,
      };
    }
    quotesBySupplier[supplierId].items.push(quote);
    quotesBySupplier[supplierId].total_price += parseFloat(quote.total_price) || 0;
    if (quote.lead_time) {
      quotesBySupplier[supplierId].lead_time = Math.max(
        quotesBySupplier[supplierId].lead_time || 0,
        quote.lead_time
      );
    }
    if (quote.payment_terms) {
      quotesBySupplier[supplierId].payment_terms = quote.payment_terms;
    }
  });
  const supplierList = Object.values(quotesBySupplier);


  // æ™ºèƒ½åˆ†æå’Œæ¨è
  const analyzeQuotes = (quotes) => {
    if (!quotes || quotes.length === 0) return {};

    const prices = quotes.map(q => Number(q.total_price) || Infinity);
    const leadTimes = quotes.map(q => Number(q.lead_time) || Infinity);

    const lowestPrice = Math.min(...prices);
    const fastestLeadTime = Math.min(...leadTimes);
    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

    return { lowestPrice, fastestLeadTime, avgPrice };
  };

  // è®¡ç®—ç»¼åˆè¯„åˆ†
  const calculateScore = (quote, analysis) => {
    if (!quote.total_price || !quote.lead_time) return 0;

    const priceScore = ((analysis.avgPrice - quote.total_price) / analysis.avgPrice) * 50 + 50;
    const speedScore = ((30 - quote.lead_time) / 30) * 50;

    return Math.max(0, Math.min(100, (priceScore + speedScore) / 2));
  };

  // æ™ºèƒ½æ¨èæœ€ä½³ä¾›åº”å•†
  const getRecommendation = (quote, quotes) => {
    const analysis = analyzeQuotes(quotes);
    const score = calculateScore(quote, analysis);

    const isBestPrice = quote.total_price === analysis.lowestPrice;
    const isFastestDelivery = quote.lead_time === analysis.fastestLeadTime;
    const isBestValue = isBestPrice && isFastestDelivery;

    return {
      score,
      isBestPrice,
      isFastestDelivery,
      isBestValue,
      recommendation: score >= 75 ? 'best' : score >= 60 ? 'good' : null,
    };
  };

  // è‡ªåŠ¨é€‰æ‹©æ¨èä¾›åº”å•†
  useEffect(() => {
    if (autoRecommend && rfq.quotes && rfq.quotes.length > 0) {
      const recommended = new Set();
      Object.values(quotesByItem).forEach(({ quotes }) => {
        const analysis = analyzeQuotes(quotes);
        quotes.forEach(quote => {
          const rec = getRecommendation(quote, quotes);
          if (rec.recommendation === 'best') {
            recommended.add(quote.supplier_id);
          }
        });
      });
      setSelectedSuppliers(recommended);
    }
  }, [rfq, autoRecommend]);

  const toggleSupplier = (supplierId) => {
    const newSet = new Set(selectedSuppliers);
    if (newSet.has(supplierId)) {
      newSet.delete(supplierId);
    } else {
      newSet.add(supplierId);
    }
    setSelectedSuppliers(newSet);
  };

  const handleCreatePO = async () => {
    if (selectedSuppliers.size === 0) {
      alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä¸­æ ‡ä¾›åº”å•†");
      return;
    }

    if (!window.confirm(`ç¡®è®¤é€‰æ‹© ${selectedSuppliers.size} ä¸ªä¾›åº”å•†ä¸­æ ‡å¹¶åˆ›å»ºé‡‡è´­è®¢å•ï¼Ÿ`)) {
      return;
    }

    setLoadingCreate(true);
    try {
      const selectedQuotes = (rfq.quotes || []).filter(q =>
        selectedSuppliers.has(q.supplier_id)
      );

      await api.post(ENDPOINTS.RFQ.CREATE_PO(rfq.id), {
        selected_quotes: selectedQuotes.map(q => q.id),
      });

      alert(`âœ… é‡‡è´­è®¢å•åˆ›å»ºæˆåŠŸï¼å·²é€‰æ‹© ${selectedSuppliers.size} å®¶ä¾›åº”å•†ä¸­æ ‡`);
      if (onSelectWinner) {
        onSelectWinner(Array.from(selectedSuppliers));
      }
      onClose();
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || "åˆ›å»ºé‡‡è´­è®¢å•å¤±è´¥";
      alert(`âŒ ${msg}`);
    } finally {
      setLoadingCreate(false);
    }
  };

  // è®¡ç®—é€‰ä¸­ä¾›åº”å•†æ€»é‡‘é¢
  const calculateTotalAmount = () => {
    return (rfq.quotes || [])
      .filter(q => selectedSuppliers.has(q.supplier_id))
      .reduce((sum, q) => sum + Number(q.total_price || 0), 0);
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2 sm:p-3 md:p-4 overflow-y-auto">
      <div className="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-7xl my-4 sm:my-6 md:my-8">
        {/* æ ‡é¢˜æ  */}
        <div className="sticky top-0 bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 text-white p-3 sm:p-4 md:p-6 rounded-t-xl sm:rounded-t-2xl z-10 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold">æ™ºèƒ½é€‰æ ‡ç³»ç»Ÿ</h2>
              <p className="text-blue-100 text-xs sm:text-sm mt-1 sm:mt-2">
                RFQ #{rfq.id} | æ”¶åˆ° {rfq.quotes?.length || 0} ä¸ªæŠ¥ä»· | AIè¾…åŠ©å†³ç­–
              </p>
            </div>
            <button
              onClick={onClose}
              className="text-white hover:bg-white/20 rounded-full p-1.5 sm:p-2 transition"
            >
              <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* å†…å®¹åŒº */}
        <div className="p-3 sm:p-4 md:p-6 space-y-3 sm:space-y-4 md:space-y-6 max-h-[70vh] overflow-y-auto">
          {/* æ™ºèƒ½æ¨èå¼€å…³ */}
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg sm:rounded-xl p-3 sm:p-4 gap-2 sm:gap-0">
            <div className="flex items-center gap-2 sm:gap-3">
              <div className="bg-blue-600 text-white rounded-full p-1.5 sm:p-2">
                <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
              </div>
              <div>
                <h3 className="text-sm sm:text-base font-bold text-gray-900">æ™ºèƒ½æ¨èæ¨¡å¼</h3>
                <p className="text-xs sm:text-sm text-gray-600">AIè‡ªåŠ¨åˆ†æå¹¶æ¨èæœ€ä½³ä¾›åº”å•†</p>
              </div>
            </div>
            <label className="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                checked={autoRecommend}
                onChange={(e) => setAutoRecommend(e.target.checked)}
                className="sr-only peer"
              />
              <div className="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          {/* RFQåŸºæœ¬ä¿¡æ¯ */}
          <div className="border-2 border-purple-200 rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-5 bg-gradient-to-br from-purple-50 to-blue-50">
            <h3 className="text-sm sm:text-base md:text-lg font-bold text-purple-900 mb-2 sm:mb-3">è¯¢ä»·å•ä¿¡æ¯</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3 md:gap-4 text-xs sm:text-sm">
              <div className="bg-white rounded-lg p-2 sm:p-3 shadow-sm">
                <label className="text-gray-600 text-xs">RFQç¼–å·</label>
                <p className="font-bold text-base sm:text-lg text-purple-600">#{rfq.id}</p>
              </div>
              <div className="bg-white rounded-lg p-2 sm:p-3 shadow-sm">
                <label className="text-gray-600 text-xs">çŠ¶æ€</label>
                <p className="text-sm sm:text-base font-semibold text-blue-600">{rfq.status}</p>
              </div>
              <div className="bg-white rounded-lg p-2 sm:p-3 shadow-sm">
                <label className="text-gray-600 text-xs">åˆ›å»ºæ—¶é—´</label>
                <p className="font-mono text-xs">
                  {rfq.created_at ? new Date(rfq.created_at).toLocaleString("zh-CN") : "-"}
                </p>
              </div>
              <div className="bg-white rounded-lg p-2 sm:p-3 shadow-sm">
                <label className="text-gray-600 text-xs">æŠ¥ä»·æ•°é‡</label>
                <p className="font-bold text-base sm:text-lg text-green-600">{rfq.quotes?.length || 0}</p>
              </div>
            </div>
          </div>

          {/* æŒ‰ç‰©æ–™æ˜¾ç¤ºæ™ºèƒ½å¯¹æ¯” */}
          {Object.values(quotesByItem).map((item, idx) => {
            const analysis = analyzeQuotes(item.quotes);

            return (
              <div key={idx} className="border-2 border-gray-200 rounded-lg sm:rounded-xl overflow-hidden shadow-lg">
                <div className="bg-gradient-to-r from-gray-100 to-gray-200 px-3 sm:px-4 md:px-6 py-3 sm:py-4 border-b-2">
                  <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
                    <div>
                      <h4 className="text-base sm:text-lg font-bold text-gray-900">
                        ğŸ“¦ {item.name}
                      </h4>
                      <p className="text-xs sm:text-sm text-gray-600 mt-1">
                        æ”¶åˆ° {item.quotes.length} ä¸ªæŠ¥ä»· | å¹³å‡ä»·æ ¼: Â¥{analysis.avgPrice?.toFixed(2) || '-'}
                      </p>
                    </div>
                    <div className="text-left sm:text-right">
                      <div className="text-xs text-gray-600">ä»·æ ¼åŒºé—´</div>
                      <div className="text-sm sm:text-base font-bold text-green-600">
                        Â¥{analysis.lowestPrice?.toFixed(2)} - Â¥{Math.max(...item.quotes.map(q => Number(q.total_price) || 0)).toFixed(2)}
                      </div>
                    </div>
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase">é€‰æ‹©</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase">ä¾›åº”å•†</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase">æŠ¥ä»·é‡‘é¢</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase hidden sm:table-cell">äº¤æœŸ</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase hidden md:table-cell">ç»¼åˆè¯„åˆ†</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase">æ™ºèƒ½æ¨è</th>
                        <th className="px-2 sm:px-3 md:px-4 py-2 sm:py-3 text-left text-xs font-bold text-gray-700 uppercase hidden lg:table-cell">å¤‡æ³¨</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {supplierList.map((supplier, sIdx) => {
                        const isSelected = selectedSuppliers.has(supplier.supplier_id);
                        const rec = { isBestPrice: supplier.total_price === Math.min(...supplierList.map(s => s.total_price || Infinity)), isFastestDelivery: supplier.lead_time === Math.min(...supplierList.map(s => s.lead_time || Infinity)), score: 50, recommendation: 'neutral' };

                        return (
                          <tr
                            key={sIdx}
                            className={`${
                              isSelected ? 'bg-blue-50 border-l-4 border-blue-500' :
                              rec.recommendation === 'best' ? 'bg-green-50' : ''
                            } hover:bg-gray-50 transition`}
                          >
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4">
                              <input
                                type="checkbox"
                                checked={isSelected}
                                onChange={() => toggleSupplier(supplier.supplier_id)}
                                className="w-5 h-5 sm:w-6 sm:h-6 text-blue-600 border-gray-300 rounded-lg focus:ring-blue-500 cursor-pointer"
                              />
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4">
                              <div className="text-xs sm:text-sm font-bold text-gray-900">
                                {supplier.supplier_name}
                              </div>
                              <div className="text-xs text-gray-500 font-mono">
                                ID: {supplier.supplier_id}
                              </div>
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4">
                              <div className={`text-sm sm:text-base font-bold ${rec.isBestPrice ? 'text-green-600' : 'text-gray-900'}`}>
                                Â¥{(supplier.total_price || 0).toLocaleString('zh-CN', { minimumFractionDigits: 2 })}
                              </div>
                              {rec.isBestPrice && (
                                <RecommendationBadge type="best" text="ğŸ’° æœ€ä½ä»·" />
                              )}
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4 hidden sm:table-cell">
                              <div className={`text-sm sm:text-base font-bold ${rec.isFastestDelivery ? 'text-blue-600' : 'text-gray-900'}`}>
                                {supplier.lead_time || '-'} å¤©
                              </div>
                              {rec.isFastestDelivery && (
                                <RecommendationBadge type="good" text="âš¡ æœ€å¿«" />
                              )}
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4 hidden md:table-cell">
                              <div className="flex items-center gap-2">
                                <div className="w-12 sm:w-16 bg-gray-200 rounded-full h-2 sm:h-3">
                                  <div
                                    className={`h-3 rounded-full ${
                                      rec.score >= 75 ? 'bg-green-500' :
                                      rec.score >= 60 ? 'bg-blue-500' : 'bg-orange-500'
                                    }`}
                                    style={{ width: `${rec.score}%` }}
                                  ></div>
                                </div>
                                <span className="text-xs sm:text-sm font-bold">{rec.score.toFixed(0)}</span>
                              </div>
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4">
                              {rec.isBestValue && (
                                <RecommendationBadge type="best" text="â­ æœ€ä½³æ€§ä»·æ¯”" />
                              )}
                              {!rec.isBestValue && rec.recommendation === 'best' && (
                                <RecommendationBadge type="best" text="âœ… å¼ºçƒˆæ¨è" />
                              )}
                              {rec.recommendation === 'good' && (
                                <RecommendationBadge type="good" text="ğŸ‘ æ¨è" />
                              )}
                            </td>
                            <td className="px-2 sm:px-3 md:px-4 py-3 sm:py-4 text-xs sm:text-sm text-gray-600 max-w-xs truncate hidden lg:table-cell">
                              {supplier.payment_terms || "-"}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })}

          {/* é€‰ä¸­ä¾›åº”å•†æ±‡æ€» */}
          {selectedSuppliers.size > 0 && (
            <div className="border-2 border-blue-300 rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-6 bg-gradient-to-br from-blue-50 to-cyan-50 shadow-lg">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 sm:mb-4 gap-2 sm:gap-0">
                <h4 className="text-base sm:text-lg font-bold text-blue-900 flex items-center gap-2">
                  <span className="bg-blue-600 text-white rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center text-sm sm:text-base">
                    {selectedSuppliers.size}
                  </span>
                  å·²é€‰æ‹©ä¾›åº”å•†
                </h4>
                <div className="text-left sm:text-right">
                  <div className="text-xs sm:text-sm text-gray-600">é¢„è®¡æ€»é‡‘é¢</div>
                  <div className="text-xl sm:text-2xl font-bold text-blue-600">
                    Â¥{calculateTotalAmount().toLocaleString('zh-CN', { minimumFractionDigits: 2 })}
                  </div>
                </div>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                {Array.from(selectedSuppliers).map(supplierId => {
                  const supplierQuotes = (rfq.quotes || []).filter(q => q.supplier_id === supplierId);
                  const supplierName = supplierQuotes[0]?.supplier_name || `ä¾›åº”å•† #${supplierId}`;
                  const totalAmount = supplierQuotes.reduce((sum, q) => sum + (q.total_price || 0), 0);
                  const itemCount = supplierQuotes.length;

                  return (
                    <div key={supplierId} className="bg-white border-2 border-blue-300 rounded-lg p-3 sm:p-4 shadow-sm hover:shadow-md transition">
                      <div className="text-sm sm:text-base font-bold text-gray-900">{supplierName}</div>
                      <div className="text-xs sm:text-sm text-gray-600 mt-1">{itemCount} ä¸ªç‰©æ–™é¡¹</div>
                      <div className="text-base sm:text-lg font-bold text-blue-600 mt-2">
                        Â¥{totalAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>

        {/* æ“ä½œæŒ‰é’® */}
        <div className="sticky bottom-0 bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 p-3 sm:p-4 md:p-6 rounded-b-xl sm:rounded-b-2xl flex flex-col sm:flex-row gap-2 sm:gap-3 md:gap-4">
          <button
            onClick={onClose}
            className="px-4 py-2 sm:px-6 sm:py-2.5 md:px-8 md:py-3 border-2 border-gray-300 text-gray-700 rounded-lg sm:rounded-xl hover:bg-gray-200 transition font-bold text-sm sm:text-base md:text-lg"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleCreatePO}
            disabled={selectedSuppliers.size === 0 || loadingCreate}
            className="flex-1 px-4 py-2 sm:px-6 sm:py-2.5 md:px-8 md:py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg sm:rounded-xl hover:from-blue-700 hover:to-purple-700 transition font-bold text-sm sm:text-base md:text-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
          >
            {loadingCreate ? (
              <span className="flex items-center justify-center gap-2">
                <div className="animate-spin rounded-full h-4 w-4 sm:h-5 sm:w-5 border-b-2 border-white"></div>
                åˆ›å»ºä¸­...
              </span>
            ) : (
              <span className="break-words">âœ… ç¡®è®¤é€‰ä¸­æ ‡å¹¶åˆ›å»ºé‡‡è´­è®¢å• ({selectedSuppliers.size}å®¶ | Â¥{calculateTotalAmount().toFixed(2)})</span>
            )}
          </button>
        </div>
      </div>
    </div>
  );
}

// ä¸»é¡µé¢ç»„ä»¶
export default function TransactionConfirmPage() {
  const [loading, setLoading] = useState(false);
  const [rfqList, setRfqList] = useState([]);
  const [selectedRFQ, setSelectedRFQ] = useState(null);
  const [error, setError] = useState("");
  const [filter, setFilter] = useState("all");
  const [searchText, setSearchText] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");

  useEffect(() => {
    loadRFQs();
  }, []);

  const loadRFQs = async () => {
    setLoading(true);
    setError("");
    try {
      const response = await api.get(ENDPOINTS.RFQ.GET_OUTBOX);
      const data = Array.isArray(response) ? response : (response?.items || response?.data || []);

      const rfqsWithQuotes = await Promise.all(
        data.map(async (rfq) => {
          try {
            const quotesRes = await api.get(ENDPOINTS.RFQ.GET_QUOTES(rfq.id));
            return {
              ...rfq,
              quotes: quotesRes?.quotes || quotesRes?.items || [],
            };
          } catch (e) {
            console.error(`Failed to load quotes for RFQ ${rfq.id}:`, e);
            return { ...rfq, quotes: [] };
          }
        })
      );

      setRfqList(rfqsWithQuotes);
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || "åŠ è½½å¤±è´¥";
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  const filteredRFQs = rfqList.filter(rfq => {
    // ç­›é€‰çŠ¶æ€
    if (filter === "with_quotes" && (rfq.quotes?.length || 0) === 0) return false;
    if (filter === "no_quotes" && (rfq.quotes?.length || 0) > 0) return false;
    if (filter === "ready" && ((rfq.quotes?.length || 0) === 0 || rfq.status === 'po_created')) return false;

    // æœç´¢æ–‡æœ¬
    if (searchText) {
      const search = searchText.toLowerCase();
      const idMatch = String(rfq.id).includes(search);
      const noteMatch = (rfq.note || "").toLowerCase().includes(search);
      const prMatch = (rfq.pr_number || "").toLowerCase().includes(search);
      if (!idMatch && !noteMatch && !prMatch) return false;
    }

    // æ—¶é—´èŒƒå›´ç­›é€‰
    if (startDate && rfq.created_at) {
      const rfqDate = new Date(rfq.created_at);
      const start = new Date(startDate);
      start.setHours(0, 0, 0, 0);
      if (rfqDate < start) return false;
    }
    if (endDate && rfq.created_at) {
      const rfqDate = new Date(rfq.created_at);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);
      if (rfqDate > end) return false;
    }

    return true;
  });

  const stats = {
    total: rfqList.length,
    withQuotes: rfqList.filter(r => (r.quotes?.length || 0) > 0).length,
    noQuotes: rfqList.filter(r => (r.quotes?.length || 0) === 0).length,
    ready: rfqList.filter(r => (r.quotes?.length || 0) > 0 && r.status !== 'po_created').length,
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50 p-3 sm:p-4 md:p-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 text-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 mb-4 sm:mb-6 shadow-2xl">
        <div className="flex items-center gap-2 sm:gap-3 md:gap-4 mb-2 sm:mb-3">
          <div className="bg-white/20 rounded-full p-2 sm:p-3">
            <svg className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
          </div>
          <div>
            <h1 className="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold">æ™ºèƒ½é€‰æ ‡ç³»ç»Ÿ</h1>
            <p className="text-blue-100 mt-1 sm:mt-2 text-sm sm:text-base md:text-lg">AIè¾…åŠ©å†³ç­– Â· è‡ªåŠ¨åŒ–å¯¹æ¯” Â· æœ€ä¼˜ä¾›åº”å•†æ¨è</p>
          </div>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3 md:gap-4 mb-4 sm:mb-6">
        <button
          onClick={() => setFilter("all")}
          className={`p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl border-2 transition shadow-lg hover:shadow-xl ${
            filter === "all"
              ? "bg-gradient-to-br from-blue-500 to-blue-600 border-blue-600 text-white transform scale-105"
              : "bg-white border-gray-200 hover:border-blue-300"
          }`}
        >
          <div className={`text-xs sm:text-sm ${filter === "all" ? "text-blue-100" : "text-gray-600"}`}>å…¨éƒ¨RFQ</div>
          <div className={`text-2xl sm:text-3xl md:text-4xl font-bold mt-1 sm:mt-2 ${filter === "all" ? "text-white" : "text-blue-600"}`}>
            {stats.total}
          </div>
        </button>

        <button
          onClick={() => setFilter("ready")}
          className={`p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl border-2 transition shadow-lg hover:shadow-xl ${
            filter === "ready"
              ? "bg-gradient-to-br from-green-500 to-green-600 border-green-600 text-white transform scale-105"
              : "bg-white border-gray-200 hover:border-green-300"
          }`}
        >
          <div className={`text-xs sm:text-sm ${filter === "ready" ? "text-green-100" : "text-gray-600"}`}>å¾…é€‰æ ‡</div>
          <div className={`text-2xl sm:text-3xl md:text-4xl font-bold mt-1 sm:mt-2 ${filter === "ready" ? "text-white" : "text-green-600"}`}>
            {stats.ready}
          </div>
        </button>

        <button
          onClick={() => setFilter("with_quotes")}
          className={`p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl border-2 transition shadow-lg hover:shadow-xl ${
            filter === "with_quotes"
              ? "bg-gradient-to-br from-purple-500 to-purple-600 border-purple-600 text-white transform scale-105"
              : "bg-white border-gray-200 hover:border-purple-300"
          }`}
        >
          <div className={`text-xs sm:text-sm ${filter === "with_quotes" ? "text-purple-100" : "text-gray-600"}`}>
            å·²æ”¶åˆ°æŠ¥ä»·
          </div>
          <div className={`text-2xl sm:text-3xl md:text-4xl font-bold mt-1 sm:mt-2 ${filter === "with_quotes" ? "text-white" : "text-purple-600"}`}>
            {stats.withQuotes}
          </div>
        </button>

        <button
          onClick={() => setFilter("no_quotes")}
          className={`p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl border-2 transition shadow-lg hover:shadow-xl ${
            filter === "no_quotes"
              ? "bg-gradient-to-br from-orange-500 to-orange-600 border-orange-600 text-white transform scale-105"
              : "bg-white border-gray-200 hover:border-orange-300"
          }`}
        >
          <div className={`text-xs sm:text-sm ${filter === "no_quotes" ? "text-orange-100" : "text-gray-600"}`}>
            å¾…æ”¶æŠ¥ä»·
          </div>
          <div className={`text-2xl sm:text-3xl md:text-4xl font-bold mt-1 sm:mt-2 ${filter === "no_quotes" ? "text-white" : "text-orange-600"}`}>
            {stats.noQuotes}
          </div>
        </button>
      </div>

      {/* æœç´¢å’Œç­›é€‰æ  */}
      <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
          {/* æœç´¢æ¡† */}
          <div className="md:col-span-1">
            <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
              ğŸ” æœç´¢
            </label>
            <input
              type="text"
              placeholder="æœç´¢ RFQ IDã€PRç¼–å·ã€å¤‡æ³¨..."
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
              className="w-full px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
            />
          </div>

          {/* å¼€å§‹æ—¥æœŸ */}
          <div>
            <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
              ğŸ“… å¼€å§‹æ—¥æœŸ
            </label>
            <input
              type="date"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="w-full px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
            />
          </div>

          {/* ç»“æŸæ—¥æœŸ */}
          <div>
            <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
              ğŸ“… ç»“æŸæ—¥æœŸ
            </label>
            <input
              type="date"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="w-full px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
            />
          </div>
        </div>

        {/* æ¸…ç©ºç­›é€‰æŒ‰é’® */}
        {(searchText || startDate || endDate) && (
          <div className="mt-3 sm:mt-4 flex justify-end">
            <button
              onClick={() => {
                setSearchText("");
                setStartDate("");
                setEndDate("");
              }}
              className="px-4 py-2 text-sm sm:text-base text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition font-semibold"
            >
              ğŸ”„ æ¸…ç©ºç­›é€‰
            </button>
          </div>
        )}
      </div>

      {/* é”™è¯¯æç¤º */}
      {error && (
        <div className="bg-red-50 border-2 border-red-300 text-red-800 p-3 sm:p-4 rounded-lg sm:rounded-xl mb-3 sm:mb-4 shadow-lg">
          <div className="flex items-center gap-2">
            <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span className="text-sm sm:text-base font-semibold">âš ï¸ åŠ è½½å¤±è´¥: {error}</span>
          </div>
        </div>
      )}

      {/* RFQåˆ—è¡¨ */}
      <div className="bg-white rounded-xl sm:rounded-2xl shadow-2xl overflow-hidden">
        <div className="bg-gradient-to-r from-gray-100 to-gray-200 p-3 sm:p-4 md:p-6 border-b-2 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
          <h2 className="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900">
            ğŸ“‹ è¯¢ä»·å•åˆ—è¡¨ ({filteredRFQs.length})
          </h2>
          <button
            onClick={loadRFQs}
            disabled={loading}
            className="px-4 py-2 sm:px-5 sm:py-2.5 md:px-6 md:py-3 bg-blue-600 text-white rounded-lg sm:rounded-xl hover:bg-blue-700 transition disabled:opacity-50 font-semibold shadow-lg flex items-center gap-2 text-sm sm:text-base"
          >
            <svg className={`w-4 h-4 sm:w-5 sm:h-5 ${loading ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            {loading ? "åˆ·æ–°ä¸­..." : "åˆ·æ–°"}
          </button>
        </div>

        {loading ? (
          <div className="p-8 sm:p-12 md:p-16 text-center">
            <div className="inline-block animate-spin rounded-full h-12 w-12 sm:h-14 sm:w-14 md:h-16 md:w-16 border-b-4 border-blue-600"></div>
            <p className="mt-3 sm:mt-4 text-gray-600 text-base sm:text-lg">æ™ºèƒ½åŠ è½½ä¸­...</p>
          </div>
        ) : filteredRFQs.length === 0 ? (
          <div className="p-8 sm:p-12 md:p-16 text-center text-gray-500">
            <div className="text-5xl sm:text-6xl md:text-7xl lg:text-8xl mb-3 sm:mb-4">ğŸ“­</div>
            <p className="text-lg sm:text-xl md:text-2xl font-semibold">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è¯¢ä»·å•</p>
            <p className="text-sm sm:text-base text-gray-400 mt-2">è¯·å°è¯•åˆ‡æ¢å…¶ä»–ç­›é€‰æ¡ä»¶</p>
          </div>
        ) : (
          <div className="divide-y-2">
            {filteredRFQs.map((rfq) => {
              const quotesCount = rfq.quotes?.length || 0;
              const hasQuotes = quotesCount > 0;
              const canSelect = hasQuotes && rfq.status !== 'po_created';

              return (
                <div
                  key={rfq.id}
                  className={`p-3 sm:p-4 md:p-6 transition ${canSelect ? 'hover:bg-blue-50 cursor-pointer' : 'hover:bg-gray-50'}`}
                  onClick={() => canSelect && setSelectedRFQ(rfq)}
                >
                  <div className="flex flex-col sm:flex-row items-start justify-between gap-3 sm:gap-0">
                    <div className="flex-1">
                      <div className="flex flex-wrap items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                        <h3 className="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                          RFQ #{rfq.id}
                        </h3>
                        {hasQuotes ? (
                          <span className="px-3 py-1 sm:px-4 sm:py-1 rounded-full text-xs sm:text-sm font-bold bg-gradient-to-r from-green-500 to-green-600 text-white shadow-sm">
                            âœ… {quotesCount} ä¸ªæŠ¥ä»·
                          </span>
                        ) : (
                          <span className="px-3 py-1 sm:px-4 sm:py-1 rounded-full text-xs sm:text-sm font-bold bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-sm">
                            â³ å¾…æ”¶æŠ¥ä»·
                          </span>
                        )}
                        {rfq.status === 'po_created' && (
                          <span className="px-3 py-1 sm:px-4 sm:py-1 rounded-full text-xs sm:text-sm font-bold bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-sm">
                            ğŸ“‹ å·²åˆ›å»ºPO
                          </span>
                        )}
                        {rfq.status && rfq.status !== 'po_created' && (
                          <span className="px-2 py-1 sm:px-3 sm:py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                            {rfq.status}
                          </span>
                        )}
                      </div>

                      <div className="text-xs sm:text-sm text-gray-600 space-y-1 sm:space-y-2">
                        {rfq.note && <div>ğŸ“ å¤‡æ³¨: {rfq.note}</div>}
                        <div>ğŸ“… åˆ›å»ºæ—¶é—´: {rfq.created_at ? new Date(rfq.created_at).toLocaleString("zh-CN") : "-"}</div>
                        {hasQuotes && (
                          <div className="mt-1 sm:mt-2 text-blue-600 font-semibold">
                            ğŸ’° æ”¶åˆ° {quotesCount} ä»½æŠ¥ä»·ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¹¶è¿›è¡Œæ™ºèƒ½é€‰æ ‡
                          </div>
                        )}
                      </div>
                    </div>

                    {canSelect && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setSelectedRFQ(rfq);
                        }}
                        className="w-full sm:w-auto px-4 py-2 sm:px-5 sm:py-2.5 md:px-6 md:py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg sm:rounded-xl hover:from-green-700 hover:to-blue-700 transition font-bold shadow-lg sm:ml-4 whitespace-nowrap text-sm sm:text-base"
                      >
                        ğŸ¯ æ™ºèƒ½é€‰æ ‡
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* RFQè¯¦æƒ…æ¨¡æ€æ¡† */}
      {selectedRFQ && (
        <RFQDetailModal
          rfq={selectedRFQ}
          onClose={() => setSelectedRFQ(null)}
          onSelectWinner={() => {
            loadRFQs();
          }}
        />
      )}
    </div>
  );
}
