import React, { useEffect, useMemo, useState } from "react";
import RFQSendPanel from "../components/RFQSendPanel.jsx";
import ManualQuoteModal from "../components/ManualQuoteModal.jsx";
import { api } from "../api/http";
import { useAuth } from "../auth/AuthContext";

/**
 * åŠŸèƒ½å®Œæ•´çš„é‡‡è´­å•å‘é€é¡µé¢
 * åŒ…å«ï¼šPRåˆ—è¡¨ â†’ è‡ªåŠ¨åˆ†ç±» â†’ ä¾›åº”å•†åŒ¹é… â†’ åˆ›å»ºRFQ â†’ å‘é€ â†’ è¿½è¸ª
 */

export default function SendPurchasePage() {
  const { user } = useAuth();
  
  // PR åˆ—è¡¨å’Œé€‰æ‹©
  const [prList, setPrList] = useState([]);
  const [selectedPr, setSelectedPr] = useState(null);
  const [searchText, setSearchText] = useState("");
  const [loadingList, setLoadingList] = useState(false);

  // åˆ†ç±»å’ŒåŒ¹é…
  const [groups, setGroups] = useState([]);
  const [routes, setRoutes] = useState([]);
  const [routesEdited, setRoutesEdited] = useState({});  // ç”¨æˆ·è°ƒæ•´åçš„ä¾›åº”å•†

  // RFQåˆ›å»ºå’Œè¿½è¸ª
  const [rfqId, setRfqId] = useState(null);
  const [rfqStatus, setRfqStatus] = useState(null);
  const [rfqDetail, setRfqDetail] = useState(null);
  const [rfqQuotes, setRfqQuotes] = useState([]);

  // å…¨å±€çŠ¶æ€
  const [note, setNote] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [activeTab, setActiveTab] = useState("list");  // list/classify/send/track

  // æ‰‹åŠ¨æŠ¥ä»·Modal
  const [showManualQuoteModal, setShowManualQuoteModal] = useState(false);
  const [manualQuoteRfq, setManualQuoteRfq] = useState(null);

  const totalQty = useMemo(
    () => (selectedPr?.items?.length || 0) > 0 
      ? selectedPr.items.reduce((s, i) => s + (Number(i.qty) || 0), 0)
      : 0,
    [selectedPr]
  );

  // ============= 1. åŠ è½½å·²æ‰¹å‡†æœªå‘é€çš„PRåˆ—è¡¨ =============
  const loadApprovedPRList = async () => {
    setLoadingList(true);
    setErr("");
    try {
      const data = await api.get(`/api/v1/pr/approved-not-sent`);
      
      // âœ… ä¿®å¤ï¼šç¡®ä¿ prList å§‹ç»ˆæ˜¯æ•°ç»„
      // å¤„ç†å¤šç§å¯èƒ½çš„å“åº”æ ¼å¼
      let list = [];
      if (Array.isArray(data)) {
        list = data;
      } else if (data?.data && Array.isArray(data.data)) {
        list = data.data;
      } else if (data?.items && Array.isArray(data.items)) {
        list = data.items;
      }
      
      console.log("âœ… åŠ è½½çš„PRåˆ—è¡¨:", list);  // è°ƒè¯•ç”¨
      setPrList(list);
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      console.error("âŒ åŠ è½½PRåˆ—è¡¨é”™è¯¯:", msg, e);  // è°ƒè¯•ç”¨
      setErr(`åŠ è½½PRåˆ—è¡¨å¤±è´¥: ${msg}`);
      setPrList([]);
    } finally {
      setLoadingList(false);
    }
  };

  // åˆå§‹åŠ è½½
  useEffect(() => {
    loadApprovedPRList();
  }, []);

  // ============= 2. é€‰æ‹©PRå¹¶åŠ è½½è¯¦æƒ… + è‡ªåŠ¨åˆ†ç±»åŒ¹é… =============
  const selectPR = async (pr) => {
    setLoading(true);
    setErr("");
    try {
      const detail = await api.get(`/api/v1/pr/requests/${pr.id}`);
      setSelectedPr(detail);
      setGroups([]);
      setRoutes([]);
      setRoutesEdited({});
      setRfqId(null);
      setRfqStatus(null);
      setRfqQuotes([]);
      setNote("");
      setActiveTab("classify");

      // ğŸš€ æ–¹æ¡ˆBï¼šè‡ªåŠ¨è§¦å‘åˆ†ç±»å’ŒåŒ¹é…
      if (detail.items && detail.items.length > 0) {
        // è°ƒç”¨åˆ†ç±»æ¥å£
        const classifyData = await api.post(`/api/v1/ai/classify-batch`, {
          items: detail.items
        });
        setGroups(classifyData.groups || []);

        // è‡ªåŠ¨åŒ¹é…ä¾›åº”å•†
        const supplierData = await api.post(`/api/v1/rfqs/classify-suppliers`, {
          groups: classifyData.groups || []
        });
        setRoutes(supplierData.routes || []);
      }
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      setErr(`åŠ è½½PRè¯¦æƒ…å¤±è´¥: ${msg}`);
    } finally {
      setLoading(false);
    }
  };

  // ============= æ‰‹åŠ¨æŠ¥ä»· =============
  const openManualQuote = async (pr, e) => {
    e.stopPropagation();  // é˜²æ­¢è§¦å‘selectPR
    setLoading(true);
    setErr("");
    try {
      // åŠ è½½PRè¯¦æƒ…å’ŒRFQä¿¡æ¯
      const detail = await api.get(`/api/v1/pr/requests/${pr.id}`);

      // æ£€æŸ¥æ˜¯å¦å·²æœ‰RFQ
      let rfqData = null;
      try {
        const rfqResponse = await api.get(`/api/v1/rfqs?pr_id=${pr.id}`);
        if (rfqResponse.items && rfqResponse.items.length > 0) {
          rfqData = rfqResponse.items[0];
          // åŠ è½½RFQè¯¦æƒ…ï¼ˆåŒ…æ‹¬itemsï¼‰
          const rfqDetailResponse = await api.get(`/api/v1/rfqs/${rfqData.id}`);
          rfqData = rfqDetailResponse;
        }
      } catch (e) {
        console.log('æœªæ‰¾åˆ°å·²æœ‰RFQï¼Œå°†åˆ›å»ºæ–°RFQ');
      }

      // å¦‚æœæ²¡æœ‰RFQï¼Œå…ˆåˆ›å»ºä¸€ä¸ªï¼ˆè·³è¿‡è‡ªåŠ¨å‘é€ï¼‰
      if (!rfqData) {
        const createResponse = await api.post(`/api/v1/rfqs`, {
          pr_id: pr.id,
          note: "æ‰‹åŠ¨æŠ¥ä»·",
          classification_results: [],
          skip_send: true  // è·³è¿‡è‡ªåŠ¨å‘é€ï¼Œåªåˆ›å»ºRFQ
        });
        rfqData = createResponse;
      }

      // å°†PRä¿¡æ¯é™„åŠ åˆ°rfqData
      rfqData.pr_detail = detail;

      setManualQuoteRfq(rfqData);
      setShowManualQuoteModal(true);
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      setErr(`æ‰“å¼€æ‰‹åŠ¨æŠ¥ä»·å¤±è´¥: ${msg}`);
    } finally {
      setLoading(false);
    }
  };

  const handleManualQuoteSuccess = (response) => {
    setShowManualQuoteModal(false);
    setManualQuoteRfq(null);
    loadApprovedPRList();  // åˆ·æ–°åˆ—è¡¨

    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    const posCount = response?.pos_created?.length || 0;
    const message = `âœ… æ‰‹åŠ¨æŠ¥ä»·æäº¤æˆåŠŸï¼\nå·²è‡ªåŠ¨åˆ›å»º ${posCount} ä¸ªé‡‡è´­è®¢å•\nä¸‹ä¸€æ­¥ï¼šå»å‘ç¥¨ç®¡ç†ä¸Šä¼ å‘ç¥¨`;
    alert(message);
  };

  // ============= 3. è‡ªåŠ¨åˆ†ç±»å’ŒåŒ¹é… =============
  const classify = async () => {
    if (!selectedPr?.items?.length) return;
    setLoading(true);
    setErr("");
    try {
      // è°ƒç”¨åˆ†ç±»æ¥å£
      const classifyData = await api.post(`/api/v1/ai/classify-batch`, { 
        items: selectedPr.items 
      });
      setGroups(classifyData.groups || []);

      // è‡ªåŠ¨åŒ¹é…ä¾›åº”å•†
      const supplierData = await api.post(`/api/v1/rfqs/classify-suppliers`, { 
        groups: classifyData.groups || [] 
      });
      setRoutes(supplierData.routes || []);
      setRoutesEdited({});  // é‡ç½®ç¼–è¾‘çŠ¶æ€
      setActiveTab("send");
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      setErr(`åˆ†ç±»æˆ–åŒ¹é…å¤±è´¥: ${msg}`);
    } finally {
      setLoading(false);
    }
  };

  // ============= 4. åˆ›å»ºå¹¶å‘é€RFQï¼ˆæ–¹æ¡ˆBï¼šä¸€é”®å®Œæˆï¼‰=============
  const createAndSendRFQ = async () => {
    if (!selectedPr || !routes.length) return;
    setLoading(true);
    setErr("");
    try {
      // å‡†å¤‡åˆ†ç±»ç»“æœ
      const classificationResults = [];
      if (groups && groups.length > 0) {
        for (const group of groups) {
          for (const item of (group.items || [])) {
            const prItem = selectedPr.items.find(p =>
              p.name === item.name && p.spec === item.spec
            );
            if (prItem) {
              classificationResults.push({
                pr_item_id: prItem.id,
                category: group.category
              });
            }
          }
        }
      }

      // ğŸš€ åˆ›å»ºRFQï¼ˆè‡ªåŠ¨å‘é€æ¨¡å¼ï¼‰
      const data = await api.post(`/api/v1/rfqs`, {
        pr_id: Number(selectedPr.id),
        user_id: user?.id || 1,
        note,
        classification_results: classificationResults.length > 0 ? classificationResults : undefined,
        // skip_send: false  // é»˜è®¤è‡ªåŠ¨å‘é€
      });

      setRfqId(data.id);
      setRfqDetail(data);
      setActiveTab("track");

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      alert("âœ… RFQå·²åˆ›å»ºå¹¶å‘é€ç»™ä¾›åº”å•†ï¼\nåå°æ­£åœ¨å¼‚æ­¥å¤„ç†é€šçŸ¥ä»»åŠ¡...");

      // ç«‹å³è·å–çŠ¶æ€
      setTimeout(async () => {
        try {
          const status = await api.get(`/api/v1/rfqs/${data.id}/status`);
          setRfqStatus(status);
          const quotesData = await api.get(`/api/v1/rfqs/${data.id}/quotes`);
          setRfqQuotes(quotesData.quotes || []);
        } catch (e) {
          console.error("è·å–åˆå§‹çŠ¶æ€å¤±è´¥", e);
        }
      }, 500);
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      setErr(`åˆ›å»ºå¹¶å‘é€RFQå¤±è´¥: ${msg}`);
    } finally {
      setLoading(false);
    }
  };

  // ============= 5. å‘é€RFQ =============
  const sendRFQ = async () => {
    if (!rfqId) return;
    setLoading(true);
    setErr("");
    try {
      // ä½¿ç”¨ç¼–è¾‘åçš„è·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹è·¯ç”±
      const routesToSend = routesEdited && Object.keys(routesEdited).length > 0 
        ? routesEdited 
        : routes.reduce((acc, r) => {
            acc[r.category] = r.supplierIds;
            return acc;
          }, {});

      await api.post(`/api/v1/rfqs/${rfqId}/send`, { 
        routes: routesToSend
      });
      
      // åˆ·æ–°RFQçŠ¶æ€
      await getRFQStatus();
      alert("RFQå·²æˆåŠŸå‘é€");
    } catch (e) {
      const msg = e?.response?.data?.error || e?.message || String(e);
      setErr(`å‘é€RFQå¤±è´¥: ${msg}`);
    } finally {
      setLoading(false);
    }
  };

  // ============= 6. è·å–RFQçŠ¶æ€ =============
  const getRFQStatus = async () => {
    if (!rfqId) return;
    try {
      const status = await api.get(`/api/v1/rfqs/${rfqId}/status`);
      setRfqStatus(status);
    } catch (e) {
      console.error("è·å–RFQçŠ¶æ€å¤±è´¥", e);
    }
  };

  // ============= 7. è·å–RFQæŠ¥ä»· =============
  const getRFQQuotes = async () => {
    if (!rfqId) return;
    try {
      const data = await api.get(`/api/v1/rfqs/${rfqId}/quotes`);
      setRfqQuotes(data.quotes || []);
    } catch (e) {
      console.error("è·å–æŠ¥ä»·å¤±è´¥", e);
    }
  };

  useEffect(() => {
    if (rfqId && activeTab === "track") {
      // ç«‹å³è·å–ä¸€æ¬¡çŠ¶æ€
      getRFQStatus();
      getRFQQuotes();

      // ç„¶åæ¯3ç§’åˆ·æ–°ä¸€æ¬¡
      const timer = setInterval(() => {
        getRFQStatus();
        getRFQQuotes();
      }, 3000);
      return () => clearInterval(timer);
    }
  }, [rfqId, activeTab]);

  // ç¼–è¾‘ä¾›åº”å•†é€‰æ‹©
  const toggleSupplier = (category, supplierId) => {
    setRoutesEdited(prev => {
      const updated = { ...prev };
      if (!updated[category]) {
        updated[category] = routes.find(r => r.category === category)?.supplierIds || [];
      }
      const list = updated[category];
      if (list.includes(supplierId)) {
        updated[category] = list.filter(id => id !== supplierId);
      } else {
        updated[category] = [...list, supplierId];
      }
      return updated;
    });
  };

  // âœ… ä¿®å¤ï¼šè¿‡æ»¤PRåˆ—è¡¨æ—¶æ·»åŠ é˜²å¾¡æ€§æ£€æŸ¥
  const filteredPRList = prList.filter(pr => {
    // ç¡®ä¿ pr æœ‰å¿…è¦çš„å­—æ®µ
    if (!pr || typeof pr !== 'object') return false;
    
    const prNum = String(pr.prNumber || pr.id || "").toLowerCase();
    const title = String(pr.title || "").toLowerCase();
    const search = searchText.toLowerCase();
    
    return prNum.includes(search) || title.includes(search);
  });

  return (
    <div className="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 space-y-6 bg-gray-50 min-h-screen">
      <div className="bg-white rounded-xl p-4 md:p-6 shadow">
        <h1 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-800">é‡‡è´­å•å‘é€ç³»ç»Ÿ</h1>
        <p className="text-sm md:text-base text-gray-600 mt-2">æ™ºèƒ½åˆ†ç±» Â· ä¾›åº”å•†åŒ¹é… Â· è¿›åº¦è¿½è¸ª</p>
      </div>

      {err && (
        <div className="p-4 rounded border border-red-300 bg-red-50 text-red-700">
          âš ï¸ {err}
        </div>
      )}

      {/* ç®€åŒ–é€‰é¡¹å¡ - æ–¹æ¡ˆBï¼š2æ­¥æµç¨‹ */}
      <div className="flex flex-col sm:flex-row gap-2 bg-white rounded-lg p-2">
        <button
          onClick={() => setActiveTab("list")}
          className={`px-3 md:px-4 py-2 text-sm md:text-base rounded transition ${
            activeTab === "list"
              ? "bg-blue-500 text-white"
              : "bg-gray-100 text-gray-700 hover:bg-gray-200"
          }`}
        >
          1ï¸âƒ£ é€‰æ‹©PR
        </button>
        <button
          onClick={() => setActiveTab("classify")}
          disabled={!selectedPr}
          className={`px-3 md:px-4 py-2 text-sm md:text-base rounded transition disabled:opacity-50 ${
            activeTab === "classify"
              ? "bg-blue-500 text-white"
              : "bg-gray-100 text-gray-700 hover:bg-gray-200"
          }`}
        >
          2ï¸âƒ£ é¢„è§ˆå¹¶å‘é€
        </button>
        <button
          onClick={() => setActiveTab("track")}
          disabled={!rfqId}
          className={`px-3 md:px-4 py-2 text-sm md:text-base rounded transition disabled:opacity-50 ${
            activeTab === "track"
              ? "bg-blue-500 text-white"
              : "bg-gray-100 text-gray-700 hover:bg-gray-200"
          }`}
        >
          3ï¸âƒ£ è¿½è¸ªè¿›åº¦
        </button>
      </div>

      {/* ===== TAB 1: PRåˆ—è¡¨ ===== */}
      {activeTab === "list" && (
        <div className="bg-white rounded-xl p-4 md:p-6 shadow space-y-4">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <h2 className="text-lg md:text-xl font-semibold">
              å·²æ‰¹å‡†ä½†æœªå‘é€RFQçš„é‡‡è´­å•
              {/* âœ… æ˜¾ç¤ºåˆ—è¡¨æ•°é‡ */}
              <span className="text-sm text-gray-500 ml-2">
                (å…± {prList.length} ä¸ª)
              </span>
            </h2>
            <button
              onClick={loadApprovedPRList}
              disabled={loadingList}
              className="px-3 md:px-4 py-2 text-sm md:text-base bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
            >
              {loadingList ? "åˆ·æ–°ä¸­..." : "ğŸ”„ åˆ·æ–°"}
            </button>
          </div>

          {/* æœç´¢ */}
          <input
            type="text"
            placeholder="æœç´¢PRå•å·æˆ–æ ‡é¢˜..."
            value={searchText}
            onChange={e => setSearchText(e.target.value)}
            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />

          {/* åˆ—è¡¨ */}
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredPRList.length > 0 ? (
              filteredPRList.map(pr => (
                <div
                  key={pr.id}
                  onClick={() => selectPR(pr)}
                  className="p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition"
                >
                  <div className="flex items-center justify-between gap-3">
                    <div className="flex-1">
                      {/* âœ… æ”¹è¿›ï¼šæ·»åŠ  fallback å­—æ®µ */}
                      <div className="font-semibold text-gray-800">
                        {pr.prNumber || pr.id} - {pr.title || "æ— æ ‡é¢˜"}
                      </div>
                      <div className="text-sm text-gray-600 mt-1">
                        ç”³è¯·äºº: {pr.owner_name || "æœªçŸ¥"} ({pr.owner_department || "æœªçŸ¥éƒ¨é—¨"}) | ç‰©æ–™: {pr.items_count || 0} é¡¹
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        åˆ›å»ºæ—¶é—´: {pr.created_at ? new Date(pr.created_at).toLocaleString() : "-"} | ç´§æ€¥åº¦: {pr.urgency || "-"}
                      </div>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-2 items-end sm:items-center">
                      <span className="px-3 py-1 bg-green-100 text-green-700 rounded text-sm font-medium whitespace-nowrap">
                        å·²æ‰¹å‡†
                      </span>
                      <button
                        onClick={(e) => openManualQuote(pr, e)}
                        className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-medium transition whitespace-nowrap flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        æ‰‹åŠ¨æŠ¥ä»·
                      </button>
                    </div>
                  </div>
                </div>
              ))
            ) : prList.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                <div className="text-2xl mb-2">ğŸ“­</div>
                <p>æš‚æ— å·²æ‰¹å‡†æœªå‘é€RFQçš„é‡‡è´­å•</p>
                <button
                  onClick={loadApprovedPRList}
                  className="mt-3 text-blue-500 hover:text-blue-700"
                >
                  åˆ·æ–°åˆ—è¡¨
                </button>
              </div>
            ) : (
              <div className="p-8 text-center text-gray-500">
                <p>æœç´¢æ— ç»“æœï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
              </div>
            )}
          </div>

          {/* é€‰ä¸­æç¤º */}
          {selectedPr && (
            <div className="p-3 bg-blue-50 border border-blue-200 rounded text-blue-700">
              âœ… å·²é€‰æ‹©: {selectedPr.prNumber} - {selectedPr.title}
            </div>
          )}
        </div>
      )}

      {/* ===== TAB 2: åˆ†ç±»åŒ¹é… ===== */}
      {activeTab === "classify" && selectedPr && (
        <div className="bg-white rounded-xl p-4 md:p-6 shadow space-y-4">
          <h2 className="text-lg md:text-xl font-semibold">ç‰©æ–™åˆ†ç±»ä¸ä¾›åº”å•†åŒ¹é…</h2>

          {/* ç‰©æ–™åˆ—è¡¨ */}
          {selectedPr.items && selectedPr.items.length > 0 && (
            <div>
              <h3 className="text-base md:text-lg font-semibold mb-2">å¾…åˆ†ç±»ç‰©æ–™ï¼ˆå…± {selectedPr.items.length} é¡¹ï¼‰</h3>
              <div className="grid grid-cols-1 gap-2">
                {selectedPr.items.map((item, idx) => (
                  <div key={idx} className="border rounded-lg p-3 bg-gradient-to-br from-blue-50 to-blue-100">
                    <div className="flex items-center gap-2 text-sm flex-wrap">
                      <span className="font-semibold text-gray-900">{item.name}</span>
                      {item.spec && (
                        <>
                          <span className="text-gray-400">|</span>
                          <span className="text-gray-600">{item.spec}</span>
                        </>
                      )}
                      <span className="text-gray-400">|</span>
                      <span className="text-blue-600 font-medium">{item.qty} {item.unit}</span>
                      {item.remark && (
                        <>
                          <span className="text-gray-400">|</span>
                          <span className="text-gray-500 text-xs">{item.remark}</span>
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* åˆ†ç±»ç»“æœ */}
          {groups.length > 0 && (
            <div>
              <h3 className="text-base md:text-lg font-semibold mb-2">
                åˆ†ç±»ç»“æœï¼ˆå…± {groups.length} ä¸ªå“ç±»ï¼‰
              </h3>
              <div className="grid grid-cols-1 gap-3">
                {groups.map((g, idx) => (
                  <div key={idx} className="border-2 border-yellow-300 rounded-lg p-4 bg-gradient-to-br from-yellow-50 to-yellow-100">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="font-bold text-yellow-800 text-lg">
                          {g.category}
                        </div>
                        {g.major_category && (
                          <div className="text-sm text-yellow-700 mt-1">
                            ğŸ“¦ å¤§ç±»: <span className="font-semibold">{g.major_category}</span>
                          </div>
                        )}
                      </div>
                      <span className="px-3 py-1 bg-yellow-600 text-white rounded-full text-xs font-medium">
                        {(g.items || []).length} é¡¹ç‰©æ–™
                      </span>
                    </div>
                    <div className="mt-3 space-y-1">
                      {(g.items || []).map((item, itemIdx) => (
                        <div key={itemIdx} className="flex items-center gap-2 text-sm bg-white rounded px-3 py-2 border border-yellow-200 flex-wrap">
                          <span className="font-semibold text-gray-800">{item.name}</span>
                          {item.spec && (
                            <>
                              <span className="text-gray-400">|</span>
                              <span className="text-gray-600">{item.spec}</span>
                            </>
                          )}
                          <span className="text-gray-400 ml-auto">|</span>
                          <span className="text-blue-600 font-semibold">{item.qty} {item.unit}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* åŒ¹é…çš„ä¾›åº”å•† */}
          {routes.length > 0 && (
            <div>
              <h3 className="text-base md:text-lg font-semibold mb-2">ä¾›åº”å•†åŒ¹é…ç»“æœ</h3>
              <div className="grid grid-cols-1 gap-3">
                {routes.map((route, idx) => {
                  const hasSuppliers = route.supplierIds && route.supplierIds.length > 0;
                  return (
                    <div
                      key={idx}
                      className={`border-2 rounded-lg p-4 ${
                        hasSuppliers
                          ? 'border-green-300 bg-gradient-to-br from-green-50 to-green-100'
                          : 'border-orange-300 bg-gradient-to-br from-orange-50 to-orange-100'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className={`font-bold text-lg ${hasSuppliers ? 'text-green-800' : 'text-orange-800'}`}>
                            {route.category}
                          </div>
                          <div className={`text-sm mt-1 ${hasSuppliers ? 'text-green-700' : 'text-orange-700'}`}>
                            {hasSuppliers ? (
                              <>âœ… åŒ¹é…åˆ° <span className="font-semibold">{route.supplierIds.length}</span> å®¶ä¾›åº”å•†</>
                            ) : (
                              <>âš ï¸ è¯¥åˆ†ç±»æš‚æ— ä¾›åº”å•†</>
                            )}
                          </div>
                        </div>
                        <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                          hasSuppliers ? 'bg-green-600 text-white' : 'bg-orange-600 text-white'
                        }`}>
                          {route.supplierIds?.length || 0} å®¶
                        </div>
                      </div>
                      {hasSuppliers && (
                        <div className="mt-2 text-xs text-gray-600 bg-white rounded px-3 py-2 border border-green-200">
                          ä¾›åº”å•†ID: {route.supplierIds.join(", ")}
                        </div>
                      )}
                      {!hasSuppliers && (
                        <div className="mt-2 text-xs text-orange-700 bg-white rounded px-3 py-2 border border-orange-200">
                          ğŸ’¡ æç¤º: è¯¥åˆ†ç±»å·²æ­£ç¡®è¯†åˆ«ï¼Œä½†ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰è¯¥ç±»åˆ«çš„ä¾›åº”å•†ã€‚æ‚¨å¯ä»¥å…ˆæ·»åŠ ä¾›åº”å•†ï¼Œæˆ–ç»§ç»­å‘é€RFQä¾›ä»¥åå¤„ç†ã€‚
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* å¤‡æ³¨è¾“å…¥ */}
          <div className="border-t pt-4">
            <label className="block text-sm font-medium mb-2 text-gray-700">RFQå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <textarea
              value={note}
              onChange={e => setNote(e.target.value)}
              placeholder="è¾“å…¥RFQå¤‡æ³¨ä¿¡æ¯..."
              rows={3}
              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* ä¸€é”®å‘é€æŒ‰é’® - æ–¹æ¡ˆB */}
          <div className="flex flex-col sm:flex-row gap-3 border-t pt-4">
            {groups.length === 0 ? (
              <div className="p-4 bg-gray-50 rounded-lg text-gray-600 text-center">
                æ­£åœ¨åŠ è½½åˆ†ç±»ç»“æœ...
              </div>
            ) : (
              <>
                <button
                  onClick={createAndSendRFQ}
                  disabled={loading || routes.length === 0}
                  className="flex-1 px-4 md:px-6 py-3 text-sm md:text-base bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 font-semibold transition shadow-lg"
                >
                  {loading ? "å¤„ç†ä¸­..." : "âœ… ç¡®è®¤å‘é€RFQç»™ä¾›åº”å•†"}
                </button>
                <button
                  onClick={classify}
                  disabled={loading}
                  className="px-4 md:px-6 py-3 text-sm md:text-base bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50"
                >
                  {loading ? "å¤„ç†ä¸­..." : "ğŸ”„ é‡æ–°åˆ†ç±»"}
                </button>
              </>
            )}
          </div>

          {/* æç¤ºä¿¡æ¯ */}
          {routes.length === 0 && groups.length > 0 && (
            <div className="p-4 bg-orange-50 border border-orange-200 rounded-lg text-orange-700">
              âš ï¸ æ²¡æœ‰åŒ¹é…åˆ°ä¾›åº”å•†ï¼Œæ— æ³•å‘é€RFQã€‚è¯·å…ˆåœ¨ä¾›åº”å•†ç®¡ç†ä¸­æ·»åŠ ç›¸åº”ç±»åˆ«çš„ä¾›åº”å•†ã€‚
            </div>
          )}
          {routes.length > 0 && (
            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-700">
              ğŸ’¡ ç‚¹å‡»"ç¡®è®¤å‘é€RFQ"åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºRFQå¹¶å‘é€é‚€è¯·é‚®ä»¶ç»™åŒ¹é…çš„ä¾›åº”å•†ã€‚
            </div>
          )}
        </div>
      )}

      {/* ===== TAB 3: è¿½è¸ªè¿›åº¦ ===== */}
      {activeTab === "track" && rfqId && (
        <div className="space-y-4">
          {/* è¿›åº¦å¡ç‰‡ */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-white rounded-lg p-4 shadow">
              <div className="text-gray-600 text-sm md:text-base">RFQç¼–å·</div>
              <div className="text-xl md:text-2xl font-bold text-blue-600">{rfqId}</div>
            </div>
            {rfqStatus && (
              <>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-gray-600 text-sm md:text-base">å·²å‘é€</div>
                  <div className="text-xl md:text-2xl font-bold text-blue-600">{rfqStatus.tasks?.sent || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    / {rfqStatus.tasks?.total || 0} ä¸ªä»»åŠ¡
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-gray-600 text-sm md:text-base">å·²æŠ¥ä»·</div>
                  <div className="text-xl md:text-2xl font-bold text-green-600">{rfqStatus.quotes_received || 0}</div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-gray-600 text-sm md:text-base">å¤±è´¥</div>
                  <div className="text-xl md:text-2xl font-bold text-red-600">{rfqStatus.tasks?.failed || 0}</div>
                </div>
              </>
            )}
          </div>

          {/* å‘é€çŠ¶æ€è¯¦æƒ… */}
          {rfqStatus && (
            <div className="bg-white rounded-xl p-4 md:p-6 shadow">
              <h3 className="text-base md:text-lg font-semibold mb-4">é€šçŸ¥ä»»åŠ¡è¿›åº¦</h3>
              <div className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span>å·²å‘é€</span>
                  <span className="font-medium">{rfqStatus.tasks?.sent || 0} / {rfqStatus.tasks?.total || 0}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-blue-500 h-3 rounded-full transition-all"
                    style={{
                      width: rfqStatus.tasks?.total
                        ? `${(rfqStatus.tasks?.sent / rfqStatus.tasks?.total) * 100}%`
                        : "0%"
                    }}
                  />
                </div>
                <div className="flex justify-between text-xs text-gray-600 mt-4">
                  <span>å¾…å¤„ç†: {rfqStatus.tasks?.pending}</span>
                  <span>å¤±è´¥: {rfqStatus.tasks?.failed}</span>
                </div>
              </div>
            </div>
          )}

          {/* æŠ¥ä»·åˆ—è¡¨ */}
          {rfqQuotes.length > 0 && (
            <div className="bg-white rounded-xl p-4 md:p-6 shadow">
              <h3 className="text-base md:text-lg font-semibold mb-4">ä¾›åº”å•†æŠ¥ä»·</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-2 md:p-3 text-left text-xs md:text-sm">ä¾›åº”å•†</th>
                      <th className="p-2 md:p-3 text-left text-xs md:text-sm">çŠ¶æ€</th>
                      <th className="p-2 md:p-3 text-left text-xs md:text-sm">æŠ¥ä»·æ—¶é—´</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rfqQuotes.map(quote => (
                      <tr key={quote.id} className="border-t hover:bg-gray-50">
                        <td className="p-2 md:p-3 text-xs md:text-sm">{quote.supplier_name || `ä¾›åº”å•† ${quote.supplier_id}`}</td>
                        <td className="p-2 md:p-3">
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            quote.status === 'received'
                              ? 'bg-green-100 text-green-700'
                              : 'bg-yellow-100 text-yellow-700'
                          }`}>
                            {quote.status === 'received' ? 'âœ“ å·²æŠ¥ä»·' : 'â³ å¾…æŠ¥ä»·'}
                          </span>
                        </td>
                        <td className="p-2 md:p-3 text-xs text-gray-600">
                          {quote.responded_at ? new Date(quote.responded_at).toLocaleString() : '-'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* æ“ä½œæŒ‰é’® */}
          <div className="bg-white rounded-xl p-4 md:p-6 shadow flex flex-col sm:flex-row gap-3">
            <button
              onClick={() => {
                getRFQStatus();
                getRFQQuotes();
              }}
              className="px-4 md:px-6 py-2 text-sm md:text-base border rounded-lg hover:bg-gray-100"
            >
              ğŸ”„ åˆ·æ–°çŠ¶æ€
            </button>
            <button
              onClick={() => setActiveTab("list")}
              className="px-4 md:px-6 py-2 text-sm md:text-base bg-blue-500 text-white rounded-lg hover:bg-blue-600"
            >
              â† è¿”å›åˆ—è¡¨
            </button>
          </div>
        </div>
      )}

      {/* æ‰‹åŠ¨æŠ¥ä»·Modal */}
      {showManualQuoteModal && manualQuoteRfq && (
        <ManualQuoteModal
          rfq={manualQuoteRfq}
          onClose={() => {
            setShowManualQuoteModal(false);
            setManualQuoteRfq(null);
          }}
          onSuccess={handleManualQuoteSuccess}
        />
      )}
    </div>
  );
}