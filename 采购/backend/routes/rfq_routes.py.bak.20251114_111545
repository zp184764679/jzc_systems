# routes/rfq_routes.py
# -*- coding: utf-8 -*-
from flask import Blueprint, request, jsonify
from extensions import db
from models.rfq import RFQ
from models.pr import PR
from models.supplier_quote import SupplierQuote
from models.rfq_notification_task import RFQNotificationTask
# âœ… ä½¿ç”¨æ°¸ä¹…ä¿®å¤ç‰ˆæœåŠ¡ï¼ˆåŒ…å« send_rfq / create_supplier_quotes_for_routes ç­‰ï¼‰
from services.rfq_service import RFQService
import traceback
import json
from datetime import datetime

URL_PREFIX = '/api/v1/rfqs'

bp = Blueprint('rfq', __name__)  # ä¿æŒä½ çš„åŸå®šä¹‰ï¼ˆåº”ç”¨å±‚åº”ä»¥ URL_PREFIX æ³¨å†Œï¼‰

rfq_service = RFQService()

@bp.before_request
def handle_preflight():
    """å¤„ç†CORSé¢„æ£€è¯·æ±‚"""
    if request.method == 'OPTIONS':
        return '', 200

def iso(dt):
    return dt.isoformat(timespec='seconds') if dt else None


@bp.route('/classify-suppliers', methods=['POST', 'OPTIONS'])
def route_suppliers():
    """
    æ ¹æ®åˆ†ç±»ç»“æœåŒ¹é…ä¾›åº”å•†ï¼ˆæŒ‰å“ç±»ï¼‰
    Request:
    {
      "groups": [
        { "category": "æœºæ¢°é›¶éƒ¨ä»¶/ä¼ åŠ¨", "major_category": "æœºæ¢°é›¶éƒ¨ä»¶", "items": [...] }
      ]
    }
    Response:
    {
      "routes": [
        { "category": "æœºæ¢°é›¶éƒ¨ä»¶/ä¼ åŠ¨", "supplierIds": [1, 2, 3] }
      ]
    }
    """
    if request.method == 'OPTIONS':
        return "", 204

    try:
        data = request.get_json() or {}
        groups = data.get("groups", [])

        if not groups:
            return jsonify({"error": "groups ä¸èƒ½ä¸ºç©º"}), 400

        routes = []
        for group in groups:
            category = group.get("category")
            major_category = group.get("major_category")
            if not category:
                continue
            supplier_ids = rfq_service.match_suppliers_by_category(category, major_category)
            routes.append({
                "category": category,
                "supplierIds": supplier_ids
            })

        return jsonify({
            "routes": routes,
            "message": f"åŒ¹é…æˆåŠŸï¼Œå…± {sum(len(r['supplierIds']) for r in routes)} ä¸ªä¾›åº”å•†"
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"åŒ¹é…å¤±è´¥: {str(e)}"}), 500


@bp.route('', methods=['GET', 'POST', 'OPTIONS'])
def rfqs_endpoint():
    """
    GET: æŸ¥è¯¢RFQï¼ˆæ”¯æŒ?pr_id=å‚æ•°ï¼‰
    POST: åˆ›å»ºRFQï¼ˆä»PRï¼‰- æ”¯æŒé¢„åˆ†ç±»ç»“æœ
    è‡ªåŠ¨ï¼šåŒ¹é… â†’ è½åº“æŠ¥ä»·è¡Œ â†’ ç”Ÿæˆé€šçŸ¥ä»»åŠ¡ â†’ æ ‡è®° sentï¼ˆæ°¸ä¹…ä¿®å¤ï¼‰
    """
    if request.method == 'OPTIONS':
        return "", 204

    # GETè¯·æ±‚ï¼šæŸ¥è¯¢RFQ
    if request.method == 'GET':
        try:
            pr_id = request.args.get('pr_id')
            if pr_id:
                # æŸ¥è¯¢æŒ‡å®šPRçš„RFQ
                rfqs = RFQ.query.filter_by(pr_id=int(pr_id)).all()
                return jsonify({
                    "items": [{
                        "id": rfq.id,
                        "pr_id": rfq.pr_id,
                        "status": rfq.status,
                        "note": rfq.note,
                        "created_at": iso(rfq.created_at),
                        "sent_at": iso(rfq.sent_at),
                        "items_count": len(rfq.items or [])
                    } for rfq in rfqs]
                }), 200
            else:
                # æŸ¥è¯¢æ‰€æœ‰RFQ
                rfqs = RFQ.query.order_by(RFQ.created_at.desc()).all()
                return jsonify({
                    "items": [{
                        "id": rfq.id,
                        "pr_id": rfq.pr_id,
                        "status": rfq.status,
                        "note": rfq.note,
                        "created_at": iso(rfq.created_at),
                        "sent_at": iso(rfq.sent_at),
                        "items_count": len(rfq.items or [])
                    } for rfq in rfqs]
                }), 200
        except Exception as e:
            traceback.print_exc()
            return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500

    # POSTè¯·æ±‚ï¼šåˆ›å»ºRFQ
    try:
        data = request.get_json() or {}
        pr_id = data.get('pr_id')
        user_id = data.get('user_id') or 1  # å¦‚æœæœªæä¾›ï¼Œä½¿ç”¨é»˜è®¤å€¼1ï¼ˆç³»ç»Ÿç”¨æˆ·ï¼‰
        note = (data.get('note') or '').strip()
        classification_results = data.get('classification_results')
        skip_send = data.get('skip_send', False)  # æ˜¯å¦è·³è¿‡å‘é€ï¼ˆç”¨äºæ‰‹åŠ¨æŠ¥ä»·ï¼‰

        if not pr_id:
            return jsonify({"error": "pr_idä¸ºå¿…å¡«"}), 400

        # 1) æ ¡éªŒ PR
        pr = PR.query.get(pr_id)
        if not pr:
            return jsonify({"error": "PRä¸å­˜åœ¨"}), 404
        if pr.status != 'approved':
            return jsonify({"error": "åªæœ‰å·²å®¡æ‰¹çš„PRæ‰èƒ½åˆ›å»ºRFQ"}), 400

        # 2) åˆ›å»º RFQï¼ˆå¯å¸¦é¢„åˆ†ç±»ï¼‰
        if classification_results:
            rfq = rfq_service.create_rfq_from_pr_with_classification(
                pr, user_id, note, classification_results
            )
        else:
            rfq = rfq_service.create_rfq_from_pr(pr, user_id, note)

        # 3) æ ¹æ®skip_sendå‚æ•°å†³å®šæ˜¯å¦å‘é€
        if skip_send:
            # æ‰‹åŠ¨æŠ¥ä»·æ¨¡å¼ï¼šåªåˆ›å»ºRFQï¼Œä¸å‘é€
            return jsonify({
                "id": rfq.id,
                "pr_id": rfq.pr_id,
                "status": rfq.status,
                "items": [{
                    "id": item.id,
                    "item_name": getattr(item, "item_name", None),
                    "item_spec": getattr(item, "item_spec", None),
                    "quantity": getattr(item, "quantity", None),
                    "unit": getattr(item, "unit", None),
                    "category": getattr(item, "category", None)
                } for item in (rfq.items or [])],
                "items_count": len(rfq.items or []),
                "message": "RFQåˆ›å»ºæˆåŠŸï¼ˆå¾…æ‰‹åŠ¨æŠ¥ä»·ï¼‰"
            }), 201
        else:
            # è‡ªåŠ¨å‘é€æ¨¡å¼ï¼šåŒ¹é…â†’è½åº“æŠ¥ä»·è¡Œâ†’ä»»åŠ¡â†’Celeryâ†’æ ‡è®°sent
            result = rfq_service.send_rfq(rfq, routes=None)  # routes=Noneè¡¨ç¤ºè‡ªåŠ¨åŒ¹é…

            return jsonify({
                "id": rfq.id,
                "pr_id": rfq.pr_id,
                "status": rfq.status,                     # é¢„æœŸ sent
                "items_count": len(rfq.items or []),
                "tasks_count": len(result.get("task_ids", [])),
                "created_quotes": result.get("created_quotes", 0),
                "total_suppliers": result.get("total_suppliers", 0),
                "message": "RFQåˆ›å»ºæˆåŠŸï¼Œå·²åŒ¹é…å¹¶ç”ŸæˆæŠ¥ä»·è¡Œä¸é€šçŸ¥ä»»åŠ¡"
            }), 201

    except Exception as e:
        db.session.rollback()
        traceback.print_exc()
        return jsonify({"error": f"åˆ›å»ºå¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>', methods=['GET', 'OPTIONS'])
def get_rfq(rfq_id):
    """è·å–RFQè¯¦æƒ…ï¼ˆå…¼å®¹æ–°æ—§å­—æ®µåï¼‰"""
    if request.method == 'OPTIONS':
        return "", 204

    try:
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        items_payload = []
        for item in (rfq.items or []):
            # å…¼å®¹ old/new å­—æ®µ
            name = getattr(item, "item_name", None) or getattr(item, "name", None)
            spec = getattr(item, "item_spec", None) or getattr(item, "spec", None)
            qty = (getattr(item, "quantity", None) or getattr(item, "qty", None) or 1)
            try:
                qty = int(qty)
            except Exception:
                qty = 1

            items_payload.append({
                "id": item.id,
                "item_name": name or "",
                "item_spec": spec or "",
                "quantity": qty,
                "unit": getattr(item, "unit", None),
                "category": getattr(item, "category", None),
                "major_category": getattr(item, "major_category", None),
                "minor_category": getattr(item, "minor_category", None),
                "classification_source": getattr(item, "classification_source", None),
                "classification_score": json.loads(getattr(item, "classification_score", "") or "{}")
            })

        return jsonify({
            "id": rfq.id,
            "pr_id": rfq.pr_id,
            "status": rfq.status,
            "note": rfq.note,
            "created_at": iso(rfq.created_at),
            "sent_at": iso(rfq.sent_at),
            "items": items_payload
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/match-suppliers', methods=['POST', 'OPTIONS'])
def match_suppliers(rfq_id):
    """
    ä¸ºRFQåŒ¹é…ä¾›åº”å•†ï¼ˆæŒ‰å“ç±»ï¼‰
    Returns:
    {
        "routes": {
            "category_name": [supplier_id, ...]
        }
    }
    """
    if request.method == 'OPTIONS':
        return "", 204

    try:
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        routes = rfq_service.match_suppliers_for_rfq(rfq)
        return jsonify({
            "routes": routes,
            "message": f"åŒ¹é…æˆåŠŸï¼Œå…±{sum(len(v) for v in routes.values())}ä¸ªä¾›åº”å•†"
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"åŒ¹é…å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/send', methods=['POST', 'OPTIONS'])
def send_rfq(rfq_id):
    """
    å‘é€RFQç»™ä¾›åº”å•†ï¼ˆæ°¸ä¹…ä¿®å¤æ¥å…¥ç‚¹ï¼‰
    Request:
    {
        "routes": { "category_name": [supplier_id, ...] }  // å¯é€‰ï¼›ä¸ä¼ åˆ™è‡ªåŠ¨åŒ¹é…
    }
    """
    if request.method == 'OPTIONS':
        return "", 204

    try:
        data = request.get_json() or {}
        routes = data.get('routes')  # None/{} å‡å¯ï¼ŒNone è¡¨ç¤ºè‡ªåŠ¨åŒ¹é…

        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        if rfq.status not in ['draft', 'pending']:
            return jsonify({"error": "RFQçŠ¶æ€ä¸å…è®¸å‘é€"}), 400

        # âœ… æ°¸ä¹…ä¿®å¤ï¼šåŒ¹é…â†’è½åº“æŠ¥ä»·è¡Œâ†’ä»»åŠ¡â†’Celeryâ†’æ ‡è®° sent
        result = rfq_service.send_rfq(rfq, routes=routes if routes else None)

        return jsonify({
            "message": "RFQå·²å‘é€ï¼Œå·²ç”ŸæˆæŠ¥ä»·è¡Œä¸é€šçŸ¥ä»»åŠ¡",
            "tasks_count": len(result.get("task_ids", [])),
            "created_quotes": result.get("created_quotes", 0),
            "total_suppliers": result.get("total_suppliers", 0)
        }), 200

    except Exception as e:
        db.session.rollback()
        traceback.print_exc()
        return jsonify({"error": f"å‘é€å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/manual-quote', methods=['POST', 'OPTIONS'])
def create_manual_quote(rfq_id):
    """
    æ‰‹åŠ¨å½•å…¥æŠ¥ä»·ï¼ˆå‘˜å·¥ä»£æ›¿ä¾›åº”å•†å¡«å†™æŠ¥ä»·ï¼‰
    æ— éœ€ä¾›åº”å•†ï¼Œæäº¤åè‡ªåŠ¨åˆ›å»ºPOï¼Œç›´æ¥è¿›å…¥å‘ç¥¨ä¸Šä¼ ç¯èŠ‚

    POST /api/v1/rfqs/<rfq_id>/manual-quote
    Body: {
        "quotes": [
            {
                "category": "åˆ€å…·/é“£å‰Šåˆ€å…·",
                "supplier_name": "æ‰‹åŠ¨é‡‡è´­",  // å¯é€‰
                "items": [
                    {
                        "item_name": "é“£åˆ€",
                        "item_description": "ç›´å¾„10mm",
                        "quantity_requested": 100,
                        "unit": "ä¸ª",
                        "unit_price": 45.00,
                        "subtotal": 4500.00
                    }
                ],
                "total_price": 4500.00,
                "lead_time": 7,
                "payment_terms": 90,
                "notes": "æ‰‹åŠ¨å½•å…¥"
            }
        ]
    }

    Returns:
        {
            "success": true,
            "rfq_id": 123,
            "quotes_created": 2,
            "pos_created": 2,
            "message": "æ‰‹åŠ¨æŠ¥ä»·æˆåŠŸï¼Œå·²ç”Ÿæˆé‡‡è´­è®¢å•"
        }
    """
    if request.method == 'OPTIONS':
        return "", 204

    try:
        from models.supplier import Supplier
        from models.purchase_order import PurchaseOrder
        from datetime import timedelta

        # éªŒè¯RFQå­˜åœ¨
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": f"RFQ#{rfq_id} ä¸å­˜åœ¨"}), 404

        # è·å–æŠ¥ä»·æ•°æ®
        data = request.get_json() or {}
        quotes_data = data.get('quotes', [])

        if not quotes_data:
            return jsonify({"error": "è¯·è‡³å°‘æä¾›ä¸€ä¸ªæŠ¥ä»·"}), 400

        # è·å–æˆ–åˆ›å»º"æ‰‹åŠ¨é‡‡è´­"ä¾›åº”å•†
        manual_supplier = Supplier.query.filter_by(company_name='æ‰‹åŠ¨é‡‡è´­').first()
        if not manual_supplier:
            manual_supplier = Supplier(
                company_name='æ‰‹åŠ¨é‡‡è´­',
                contact_name='ç³»ç»Ÿ',
                contact_email='manual@system.local',
                contact_phone='000-0000-0000',
                status='approved',                created_at=datetime.utcnow()
            )
            db.session.add(manual_supplier)
            db.session.flush()

        created_quotes = []
        created_pos = []

        for quote_data in quotes_data:
            supplier_name = quote_data.get('supplier_name', 'æ‰‹åŠ¨é‡‡è´­')
            category = quote_data.get('category', 'æœªåˆ†ç±»')
            items = quote_data.get('items', [])
            total_price = quote_data.get('total_price', 0)
            lead_time = quote_data.get('lead_time', 7)
            payment_terms = quote_data.get('payment_terms', 90)
            notes = quote_data.get('notes', 'æ‰‹åŠ¨å½•å…¥')

            if not items:
                return jsonify({"error": "æ¯ä¸ªæŠ¥ä»·å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç‰©æ–™"}), 400

            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å“ç±»çš„æŠ¥ä»·
            existing_quote = SupplierQuote.query.filter_by(
                rfq_id=rfq_id,
                supplier_id=manual_supplier.id,
                category=category
            ).first()

            if existing_quote:
                # æ›´æ–°å·²å­˜åœ¨çš„æŠ¥ä»·
                existing_quote.total_price = total_price
                existing_quote.supplier_name = supplier_name
                existing_quote.lead_time = lead_time
                existing_quote.payment_terms = payment_terms
                existing_quote.status = 'awarded'  # ç›´æ¥æ ‡è®°ä¸ºå·²ä¸­æ ‡
                existing_quote.responded_at = datetime.utcnow()
                existing_quote.quote_json = json.dumps({
                    "items": items,
                    "notes": notes,
                    "manual_entry": True
                }, ensure_ascii=False)
                quote = existing_quote
            else:
                # åˆ›å»ºæ–°æŠ¥ä»·
                quote = SupplierQuote(
                    rfq_id=rfq_id,
                    supplier_id=manual_supplier.id,
                    supplier_name=supplier_name,
                    category=category,
                    status='awarded',  # ç›´æ¥æ ‡è®°ä¸ºå·²ä¸­æ ‡ï¼ˆè·³è¿‡é€‰æ ‡ï¼‰
                    total_price=total_price,
                    lead_time=lead_time,
                    payment_terms=payment_terms,
                    quote_json=json.dumps({
                        "items": items,
                        "notes": notes,
                        "manual_entry": True
                    }, ensure_ascii=False),
                    created_at=datetime.utcnow(),
                    responded_at=datetime.utcnow()
                )
                db.session.add(quote)
                db.session.flush()

            created_quotes.append(quote.id)

            # è‡ªåŠ¨åˆ›å»ºPOï¼ˆè·³è¿‡é€‰æ ‡ç¯èŠ‚ï¼‰
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰PO
            existing_po = PurchaseOrder.query.filter_by(
                rfq_id=rfq_id,
                quote_id=quote.id
            ).first()

            if not existing_po:
                po = PurchaseOrder(
                    po_number=PurchaseOrder.generate_po_number(),
                    rfq_id=rfq_id,
                    quote_id=quote.id,
                    supplier_id=manual_supplier.id,
                    supplier_name=supplier_name,
                    total_price=total_price,
                    lead_time=lead_time,
                    quote_data=quote.quote_json,
                    status='confirmed',  # ç›´æ¥ç¡®è®¤
                    confirmed_at=datetime.utcnow(),
                    invoice_due_date=datetime.utcnow() + timedelta(days=7),
                    invoice_uploaded=False
                )
                db.session.add(po)
                db.session.flush()
                created_pos.append({
                    'po_number': po.po_number,
                    'supplier_name': supplier_name,
                    'total_price': float(total_price)
                })

        # æ›´æ–°RFQçŠ¶æ€ä¸ºå·²åˆ›å»ºPO
        rfq.status = 'po_created'

        db.session.commit()

        return jsonify({
            "success": True,
            "rfq_id": rfq_id,
            "quotes_created": len(created_quotes),
            "quote_ids": created_quotes,
            "pos_created": created_pos,
            "message": f"æ‰‹åŠ¨æŠ¥ä»·æˆåŠŸï¼å·²åˆ›å»º {len(created_pos)} ä¸ªé‡‡è´­è®¢å•ï¼Œç­‰å¾…å‘ç¥¨ä¸Šä¼ "
        }), 200

    except Exception as e:
        db.session.rollback()
        traceback.print_exc()
        return jsonify({"error": f"æ‰‹åŠ¨æŠ¥ä»·å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/quotes', methods=['GET', 'OPTIONS'])
def get_rfq_quotes(rfq_id):
    """è·å–RFQçš„æ‰€æœ‰æŠ¥ä»·"""
    if request.method == 'OPTIONS':
        return "", 204

    try:
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        quotes = SupplierQuote.query.filter_by(rfq_id=rfq_id).all()

        return jsonify({
            "rfq_id": rfq_id,
            "quotes": [{
                "id": q.id,
                "supplier_id": q.supplier_id,
                "supplier_name": q.supplier.company_name if q.supplier else q.supplier_name,
                "status": q.status,
                # â†“ ä¿ç•™ä½ åŸæ¥çš„è¿”å›ç»“æ„ï¼ŒåŒæ—¶å…¼å®¹æ–°å­—æ®µ
                "item_name": getattr(q, "item_name", None),
                "item_description": getattr(q, "item_description", None),
                "quantity_requested": getattr(q, "quantity_requested", None),
                "unit": getattr(q, "unit", None),
                "total_price": getattr(q, "total_price", None),
                "lead_time": getattr(q, "lead_time", None),
                "quote_data": json.loads(q.quote_json) if q.quote_json else None,
                "created_at": iso(q.created_at),
                "responded_at": iso(q.responded_at)
            } for q in quotes]
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/status', methods=['GET', 'OPTIONS'])
def get_rfq_status(rfq_id):
    """è·å–RFQå‘é€çŠ¶æ€ï¼ˆåŒ…å«é€šçŸ¥ä»»åŠ¡è¿›åº¦ï¼‰"""
    if request.method == 'OPTIONS':
        return "", 204

    try:
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        # ç»Ÿè®¡ä»»åŠ¡çŠ¶æ€
        total_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq_id).count()
        sent_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq_id, status='sent').count()
        failed_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq_id, status='failed').count()
        pending_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq_id, status='pending').count()

        # ç»Ÿè®¡æŠ¥ä»·
        quotes_received = SupplierQuote.query.filter_by(
            rfq_id=rfq_id,
            status='received'
        ).count()

        return jsonify({
            "rfq_id": rfq_id,
            "rfq_status": rfq.status,
            "tasks": {
                "total": total_tasks,
                "sent": sent_tasks,
                "pending": pending_tasks,
                "failed": failed_tasks
            },
            "quotes_received": quotes_received,
            "progress": f"{sent_tasks}/{total_tasks}"
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/classification-status', methods=['GET', 'OPTIONS'])
def get_classification_status(rfq_id):
    """è·å–RFQç‰©æ–™åˆ†ç±»çŠ¶æ€å’Œè¿›åº¦"""
    if request.method == 'OPTIONS':
        return "", 204

    try:
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404

        # è·å–åˆ†ç±»çŠ¶æ€
        classification_status = rfq.classification_status or 'completed'

        # ç»Ÿè®¡ç‰©æ–™åˆ†ç±»è¿›åº¦
        from models.rfq_item import RFQItem
        total_items = RFQItem.query.filter_by(rfq_id=rfq_id).count()
        classified_items = RFQItem.query.filter(
            RFQItem.rfq_id == rfq_id,
            RFQItem.classification_source != 'pending',
            RFQItem.category != 'åˆ†ç±»ä¸­...'
        ).count()

        # è·å–Celeryä»»åŠ¡çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
        task_state = None
        task_info = None
        if rfq.classification_task_id:
            try:
                from extensions import celery
                task = celery.AsyncResult(rfq.classification_task_id)
                task_state = task.state  # PENDING, STARTED, SUCCESS, FAILURE, RETRY
                if task.info:
                    task_info = task.info
            except Exception as e:
                logger.warning(f"æ— æ³•è·å–Celeryä»»åŠ¡çŠ¶æ€: {e}")

        return jsonify({
            "rfq_id": rfq_id,
            "classification_status": classification_status,
            "progress": {
                "total": total_items,
                "classified": classified_items,
                "percentage": round((classified_items / total_items * 100) if total_items > 0 else 100, 1)
            },
            "task": {
                "task_id": rfq.classification_task_id,
                "state": task_state,
                "info": task_info
            },
            "timestamps": {
                "started_at": rfq.classification_started_at.isoformat() if rfq.classification_started_at else None,
                "completed_at": rfq.classification_completed_at.isoformat() if rfq.classification_completed_at else None
            }
        }), 200

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500


@bp.route('/outbox', methods=['GET', 'OPTIONS'])
def list_outbox():
    """RFQ å‘ä»¶ç®±æ±‡æ€»è§†å›¾"""
    if request.method == 'OPTIONS':
        return "", 204
    try:
        rfqs = RFQ.query.filter(RFQ.status.in_(['sent', 'pending']))\
            .order_by(RFQ.created_at.desc()).all()

        def iso(dt): return dt.isoformat(timespec='seconds') if dt else None

        items = []
        for rfq in rfqs:
            cats = list({(it.category or '').strip() for it in (rfq.items or []) if (it.category or '').strip()})
            total_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq.id).count()
            sent_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq.id, status='sent').count()
            failed_tasks = RFQNotificationTask.query.filter_by(rfq_id=rfq.id, status='failed').count()
            quote_count = SupplierQuote.query.filter_by(
                rfq_id=rfq.id, status='received'
            ).distinct(SupplierQuote.supplier_id).count()
            items.append({
                "id": rfq.id,
                "rfqNumber": getattr(rfq, "rfq_number", None) or f"RFQ-{rfq.id}",
                "prNumber": getattr(rfq.pr, "pr_number", None) if getattr(rfq, "pr", None) else None,
                "status": rfq.status,  # æ·»åŠ çŠ¶æ€å­—æ®µ
                "created_at": iso(getattr(rfq, "created_at", None)),  # snake_caseç‰ˆæœ¬
                "createdAt": iso(getattr(rfq, "created_at", None)),
                "sentAt": iso(getattr(rfq, "sent_at", None)),
                "itemsCount": len(rfq.items or []),
                "categories": cats,
                "categoriesCount": len(cats),
                "supplierCount": RFQNotificationTask.query.filter_by(rfq_id=rfq.id)\
                    .distinct(RFQNotificationTask.supplier_id).count(),
                "taskTotal": total_tasks,
                "taskSent": sent_tasks,
                "taskFailed": failed_tasks,
                "quoteCount": quote_count,
            })
        return jsonify({"items": items}), 200
    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>/create-po', methods=['POST', 'OPTIONS'])
def create_po_from_rfq(rfq_id):
    """
    ä»RFQåˆ›å»ºé‡‡è´­è®¢å•ï¼ˆé€‰ä¸­æ ‡ï¼‰

    POST /api/v1/rfqs/<rfq_id>/create-po
    Body: {
        "selected_quotes": [1, 2, 3]  # é€‰ä¸­çš„æŠ¥ä»·IDåˆ—è¡¨
    }

    Returns:
        {
            "success": true,
            "rfq_id": 123,
            "selected_quotes": 3,
            "pos_created": [...],  # åˆ›å»ºçš„POåˆ—è¡¨
            "message": "æˆåŠŸåˆ›å»º 3 ä¸ªé‡‡è´­è®¢å•"
        }
    """
    if request.method == 'OPTIONS':
        return jsonify({}), 200

    try:
        from models.purchase_order import PurchaseOrder
        from datetime import timedelta

        # è·å–è¯·æ±‚æ•°æ®
        data = request.get_json() or {}
        selected_quote_ids = data.get('selected_quotes', [])

        if not selected_quote_ids:
            return jsonify({"error": "è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæŠ¥ä»·"}), 400

        # éªŒè¯RFQå­˜åœ¨
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": f"RFQ#{rfq_id} ä¸å­˜åœ¨"}), 404

        # éªŒè¯æ‰€æœ‰æŠ¥ä»·éƒ½å±äºè¿™ä¸ªRFQ
        quotes = SupplierQuote.query.filter(
            SupplierQuote.id.in_(selected_quote_ids),
            SupplierQuote.rfq_id == rfq_id
        ).all()

        if len(quotes) != len(selected_quote_ids):
            return jsonify({"error": "éƒ¨åˆ†æŠ¥ä»·ä¸å±äºè¯¥RFQ"}), 400

        # éªŒè¯æ‰€æœ‰æŠ¥ä»·éƒ½å·²æäº¤
        pending_quotes = [q for q in quotes if q.status == 'pending']
        if pending_quotes:
            return jsonify({
                "error": f"æœ‰ {len(pending_quotes)} ä¸ªæŠ¥ä»·å°šæœªæäº¤"
            }), 400

        # åˆ›å»ºPOè®°å½•
        pos_created = []
        for quote in quotes:
            # æ ‡è®°æŠ¥ä»·ä¸º"å·²ä¸­æ ‡"
            quote.status = 'awarded'

            # åˆ›å»ºPO
            po = PurchaseOrder(
                po_number=PurchaseOrder.generate_po_number(),
                rfq_id=rfq_id,
                quote_id=quote.id,
                supplier_id=quote.supplier_id,
                supplier_name=quote.supplier.company_name if quote.supplier else quote.supplier_name,
                total_price=quote.total_price or 0,
                lead_time=quote.lead_time,
                quote_data=quote.quote_json,
                status='confirmed',  # ä¿®å¤ï¼šé€‰æ ‡å³ç¡®è®¤ï¼Œä¾›åº”å•†å¯ç«‹å³çœ‹åˆ°å¾…ä¸Šä¼ å‘ç¥¨
                confirmed_at=datetime.utcnow(),
                invoice_due_date=datetime.utcnow() + timedelta(days=7),  # 7å¤©ååˆ°æœŸ
                invoice_uploaded=False
            )

            db.session.add(po)
            pos_created.append({
                'po_number': po.po_number,
                'supplier_name': po.supplier_name,
                'total_price': float(po.total_price),
                'invoice_due_date': po.invoice_due_date.isoformat() if po.invoice_due_date else None
            })

        # æ›´æ–°RFQçŠ¶æ€
        rfq.status = 'po_created'

        db.session.commit()

        # ğŸ”” å‘é€POåˆ›å»ºé€šçŸ¥ç»™ä¾›åº”å•†
        from services.notification_service import NotificationService
        for quote in quotes:
            if quote.supplier:
                # æ‰¾åˆ°å¯¹åº”çš„POï¼ˆé€šè¿‡quote_idï¼‰
                po = PurchaseOrder.query.filter_by(quote_id=quote.id).first()
                if po:
                    NotificationService.notify_po_created(po, quote.supplier)

        return jsonify({
            "success": True,
            "rfq_id": rfq_id,
            "selected_quotes": len(quotes),
            "pos_created": pos_created,
            "message": f"æˆåŠŸåˆ›å»º {len(quotes)} ä¸ªé‡‡è´­è®¢å•ï¼Œå‘ç¥¨éœ€åœ¨7å¤©å†…ä¸Šä¼ ï¼Œå·²é€šçŸ¥ä¾›åº”å•†"
        }), 200

    except Exception as e:
        db.session.rollback()
        traceback.print_exc()
        return jsonify({"error": f"åˆ›å»ºé‡‡è´­è®¢å•å¤±è´¥: {str(e)}"}), 500


@bp.route('/<int:rfq_id>', methods=['DELETE', 'OPTIONS'])
def delete_rfq(rfq_id):
    """
    åˆ é™¤RFQå¹¶æ ‡è®°PRä¸ºå¤±æ•ˆ
    
    DELETE /api/v1/rfqs/<rfq_id>
    
    Response:
    {
        "success": true,
        "message": "RFQå·²åˆ é™¤ï¼Œå…³è”PRå·²æ ‡è®°ä¸ºå¤±æ•ˆ",
        "rfq_id": 123,
        "pr_id": 456,
        "pr_status": "cancelled"
    }
    """
    if request.method == 'OPTIONS':
        return "", 204
    
    try:
        # 1. æŸ¥è¯¢RFQ
        rfq = RFQ.query.get(rfq_id)
        if not rfq:
            return jsonify({"error": "RFQä¸å­˜åœ¨"}), 404
        
        pr_id = rfq.pr_id
        
        # 2. æ ‡è®°å…³è”çš„PRä¸ºå¤±æ•ˆ
        if rfq.pr:
            rfq.pr.status = 'cancelled'
            # åŒæ—¶æ›´æ–°PR itemsçŠ¶æ€
            for item in rfq.pr.items:
                item.status = 'cancelled'
        
        # 3. åˆ é™¤RFQï¼ˆçº§è”åˆ é™¤ç›¸å…³items, quotes, tasksç­‰ï¼‰
        db.session.delete(rfq)
        
        db.session.commit()
        
        return jsonify({
            "success": True,
            "message": "RFQå·²åˆ é™¤ï¼Œå…³è”PRå·²æ ‡è®°ä¸ºå¤±æ•ˆ",
            "rfq_id": rfq_id,
            "pr_id": pr_id,
            "pr_status": "cancelled"
        }), 200
    
    except Exception as e:
        db.session.rollback()
        traceback.print_exc()
        return jsonify({"error": f"åˆ é™¤RFQå¤±è´¥: {str(e)}"}), 500
