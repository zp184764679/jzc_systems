# 采购系统改造说明

**改造日期**: 2025-11-14
**改造人员**: Claude Code
**改造内容**: 用户角色系统升级 + 采购确认审批流程

---

## 一、改造概述

本次改造主要完成以下内容：

1. **添加主管（supervisor）角色**
   - 在原有 3 层角色（user, admin, super_admin）基础上增加主管角色
   - 主管级别介于普通员工和管理员之间

2. **修改权限控制**
   - 普通员工只能查看自己的物料申请
   - 主管可以查看所有流程（包括 RFQ、供应商报价）

3. **新增采购确认审批流程**
   - 选标后需要两级审批：管理员确认 → 超管确认
   - 只有超管最终确认后，供应商才能看到中标信息

---

## 二、详细修改内容

### 1. 用户角色系统 (`models/user.py`)

#### 修改内容：
```python
# 原来的角色定义
ROLE_LEVELS = {
    'user': 0,
    'admin': 1,
    'super_admin': 2
}

# 新的角色定义
ROLE_LEVELS = {
    'user': 0,          # 普通员工
    'supervisor': 0.5,  # 主管
    'admin': 1,         # 管理员
    'super_admin': 2    # 超级管理员
}
```

#### 权限矩阵：

| 角色 | 级别 | 可管理的角色 | 可分配的角色 | 权限描述 |
|------|------|------------|------------|---------|
| user | 0 | 无 | 无 | 只能查看自己的PR，无法查看后续流程 |
| **supervisor** | **0.5** | **无** | **无** | **可查看所有PR、RFQ、报价等流程** |
| admin | 1 | user, supervisor | user, supervisor | 可审批PR，可确认PO |
| super_admin | 2 | 所有角色 | 所有角色 | 可最终确认PO |

---

### 2. 采购订单模型 (`models/purchase_order.py`)

#### 新增字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `status` | VARCHAR(50) | 扩展字段长度，支持新状态 |
| `admin_confirmed_by` | BIGINT | 管理员确认人ID |
| `admin_confirmed_at` | DATETIME | 管理员确认时间 |
| `super_admin_confirmed_by` | BIGINT | 超管确认人ID |
| `super_admin_confirmed_at` | DATETIME | 超管确认时间 |
| `confirmation_note` | TEXT | 审批备注 |

#### 新增 PO 状态：

```
created                         # 已创建（旧状态，保留兼容）
pending_admin_confirmation      # 待管理员确认（新增）
pending_super_admin_confirmation # 待超管确认（新增）
confirmed                       # 已确认
received                        # 已收货
completed                       # 已完成
cancelled                       # 已取消
```

---

### 3. 采购确认审批流程

#### 原流程：
```
选标 → 创建PO(status='confirmed') → 供应商立即可见
```

#### 新流程：
```
选标 → 创建PO(status='pending_admin_confirmation')
     ↓
管理员确认 → PO(status='pending_super_admin_confirmation')
     ↓
超管确认 → PO(status='confirmed', invoice_due_date=NOW()+7天)
     ↓
供应商可见（可上传发票）
```

---

### 4. 新增接口

#### 4.1 管理员确认 PO
```
POST /api/v1/purchase-orders/{po_id}/admin-confirm
Body: {
    "note": "确认备注（可选）"
}

权限：admin 或 super_admin
状态变化：pending_admin_confirmation → pending_super_admin_confirmation
```

#### 4.2 超管最终确认 PO
```
POST /api/v1/purchase-orders/{po_id}/super-admin-confirm
Body: {
    "note": "确认备注（可选）"
}

权限：super_admin
状态变化：pending_super_admin_confirmation → confirmed
动作：设置 invoice_due_date（7天后），通知供应商
```

#### 4.3 获取待确认 PO 列表
```
GET /api/v1/purchase-orders/pending-confirmation

权限：
- admin: 看到 pending_admin_confirmation 的订单
- super_admin: 看到 pending_admin_confirmation 和 pending_super_admin_confirmation 的订单

返回：待确认的 PO 列表
```

---

### 5. 权限控制修改

#### 5.1 PR 查询权限 (`routes/pr/query.py`)

**原逻辑**：所有用户都能查看所有 PR

**新逻辑**：
```python
# /api/v1/prs/requests 接口
if current_user_role == 'user':
    # 普通员工只能看自己的PR
    query = query.filter_by(owner_id=current_user_id)
else:
    # supervisor, admin, super_admin 可以看所有PR
    query = PR.query
```

#### 5.2 供应商查询 PO 权限 (`routes/purchase_order_routes.py`)

**原逻辑**：供应商可以查看所有状态的 PO

**新逻辑**：
```python
# /api/v1/purchase-orders 接口
if user_role == 'supplier':
    # 供应商只能看 confirmed 状态的 PO
    query = query.filter(PurchaseOrder.status == 'confirmed')
```

---

### 6. 修改的文件清单

| 文件路径 | 修改内容 |
|---------|---------|
| `models/user.py` | 添加 supervisor 角色，修改 can_assign_role 方法 |
| `models/purchase_order.py` | 添加审批字段，扩展 status 字段长度 |
| `routes/pr/query.py` | 修改 get_requests 接口权限控制 |
| `routes/rfq_routes.py` | 修改创建 PO 逻辑（2处：正常选标、手动报价） |
| `routes/purchase_order_routes.py` | 添加 3 个审批接口，修改供应商查询权限 |
| `migrations/add_po_approval_workflow.sql` | 数据库迁移脚本 |

---

## 三、部署步骤

### 步骤 1：备份数据库
```bash
mysqldump -u用户名 -p密码 数据库名 > backup_before_migration_$(date +%Y%m%d).sql
```

### 步骤 2：执行数据库迁移
```bash
cd C:\Users\Admin\Desktop\采购\backend\migrations
mysql -u用户名 -p密码 数据库名 < add_po_approval_workflow.sql
```

### 步骤 3：重启后端服务
```bash
cd C:\Users\Admin\Desktop\采购\backend
.\重启Backend.bat
```

### 步骤 4：验证迁移
```sql
-- 检查新字段是否添加成功
DESC purchase_orders;

-- 检查现有PO状态
SELECT status, COUNT(*) FROM purchase_orders GROUP BY status;
```

---

## 四、数据迁移注意事项

### 现有数据处理

**已存在的 PO 数据**：
- 现有 `status='confirmed'` 的 PO 不受影响，供应商仍可见
- 现有 `status='created'` 的 PO 需要人工审核是否需要改为 `pending_admin_confirmation`

**建议操作**：
```sql
-- 查看现有待确认的 PO（如果有）
SELECT * FROM purchase_orders WHERE status IN ('created', 'pending') ORDER BY created_at DESC;

-- 可选：将旧的 'created' 状态改为新的待确认状态
UPDATE purchase_orders
SET status = 'pending_admin_confirmation'
WHERE status = 'created' AND confirmed_at IS NULL;
```

---

## 五、测试验证

### 5.1 角色测试

**创建测试用户**：
```sql
-- 创建一个主管账号用于测试
UPDATE users SET role = 'supervisor' WHERE id = {测试用户ID};
```

**验证权限**：
1. 用普通员工登录 → 只能看到自己的 PR
2. 用主管登录 → 可以看到所有 PR、RFQ、报价
3. 用管理员登录 → 可以看到待管理员确认的 PO
4. 用超管登录 → 可以看到所有待确认的 PO

### 5.2 审批流程测试

**测试步骤**：
1. 创建 PR → 管理员审批 → 自动创建 RFQ
2. 选标 → 创建 PO（状态应为 `pending_admin_confirmation`）
3. 管理员确认 → 状态变为 `pending_super_admin_confirmation`
4. 超管确认 → 状态变为 `confirmed`，设置 `invoice_due_date`
5. 供应商登录 → 应该能看到已确认的 PO

**测试接口**：
```bash
# 1. 获取待确认PO列表
GET /api/v1/purchase-orders/pending-confirmation

# 2. 管理员确认
POST /api/v1/purchase-orders/{po_id}/admin-confirm
Content-Type: application/json
User-ID: {管理员ID}
User-Role: admin

{
  "note": "测试确认"
}

# 3. 超管确认
POST /api/v1/purchase-orders/{po_id}/super-admin-confirm
Content-Type: application/json
User-ID: {超管ID}
User-Role: super_admin

{
  "note": "最终确认"
}

# 4. 供应商查询PO
GET /api/v1/purchase-orders?supplier_id={供应商ID}
User-Role: supplier
```

---

## 六、回滚方案

如果出现问题需要回滚：

### 回滚数据库
```sql
-- 1. 删除新增字段
ALTER TABLE purchase_orders DROP FOREIGN KEY fk_po_admin_confirmer;
ALTER TABLE purchase_orders DROP FOREIGN KEY fk_po_super_admin_confirmer;
ALTER TABLE purchase_orders DROP INDEX idx_po_admin_confirmed_by;
ALTER TABLE purchase_orders DROP INDEX idx_po_super_admin_confirmed_by;
ALTER TABLE purchase_orders DROP COLUMN admin_confirmed_by;
ALTER TABLE purchase_orders DROP COLUMN admin_confirmed_at;
ALTER TABLE purchase_orders DROP COLUMN super_admin_confirmed_by;
ALTER TABLE purchase_orders DROP COLUMN super_admin_confirmed_at;
ALTER TABLE purchase_orders DROP COLUMN confirmation_note;

-- 2. 恢复 status 字段长度
ALTER TABLE purchase_orders MODIFY COLUMN status VARCHAR(20) NOT NULL DEFAULT 'created';

-- 3. 将新状态改回旧状态
UPDATE purchase_orders SET status = 'created' WHERE status IN ('pending_admin_confirmation', 'pending_super_admin_confirmation');
```

### 恢复代码
```bash
# 使用 git 回滚到改造前的版本
git checkout HEAD~1 -- models/user.py
git checkout HEAD~1 -- models/purchase_order.py
git checkout HEAD~1 -- routes/pr/query.py
git checkout HEAD~1 -- routes/rfq_routes.py
git checkout HEAD~1 -- routes/purchase_order_routes.py
```

---

## 七、前端需要配合的修改

### 7.1 用户角色显示
- 增加主管（supervisor）角色的中文显示：`主管`
- 角色选择器中添加 `supervisor` 选项

### 7.2 新增审批界面
- **待确认采购订单**页面
  - 管理员：显示 `pending_admin_confirmation` 的 PO，提供"确认"按钮
  - 超管：显示 `pending_admin_confirmation` 和 `pending_super_admin_confirmation` 的 PO，提供"确认"按钮

### 7.3 PO 状态显示
新增状态的中文映射：
```javascript
const PO_STATUS_MAP = {
  'created': '已创建',
  'pending_admin_confirmation': '待管理员确认',
  'pending_super_admin_confirmation': '待超管确认',
  'confirmed': '已确认',
  'received': '已收货',
  'completed': '已完成',
  'cancelled': '已取消'
}
```

### 7.4 权限控制
- 普通员工（user）：隐藏 RFQ、供应商报价等模块的入口
- 主管（supervisor）：显示所有模块

---

## 八、常见问题

### Q1: 如何给现有用户设置主管角色？
```sql
UPDATE users SET role = 'supervisor' WHERE id = {用户ID};
```

### Q2: 如何批量处理现有的待确认 PO？
```sql
-- 查看待处理的PO
SELECT id, po_number, supplier_name, total_price, status FROM purchase_orders
WHERE status IN ('pending_admin_confirmation', 'pending_super_admin_confirmation');

-- 批量确认（仅限紧急情况）
UPDATE purchase_orders
SET status = 'confirmed',
    admin_confirmed_by = {管理员ID},
    admin_confirmed_at = NOW(),
    super_admin_confirmed_by = {超管ID},
    super_admin_confirmed_at = NOW(),
    confirmed_at = NOW(),
    invoice_due_date = DATE_ADD(NOW(), INTERVAL 7 DAY)
WHERE status IN ('pending_admin_confirmation', 'pending_super_admin_confirmation');
```

### Q3: 供应商看不到已确认的 PO？
检查：
1. PO 状态是否为 `confirmed`
2. 供应商请求头中的 `User-Role` 是否为 `supplier`
3. 查询参数中的 `supplier_id` 是否正确

### Q4: 如何跳过审批直接确认？
```sql
-- 仅限紧急情况，手动设置为已确认
UPDATE purchase_orders
SET status = 'confirmed',
    confirmed_at = NOW(),
    invoice_due_date = DATE_ADD(NOW(), INTERVAL 7 DAY)
WHERE id = {PO_ID};
```

---

## 九、联系方式

如有问题，请联系：
- **技术支持**: [系统管理员]
- **问题反馈**: [GitHub Issues / 内部工单系统]

---

**改造完成日期**: 2025-11-14
**文档版本**: v1.0
