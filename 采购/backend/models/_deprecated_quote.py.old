# models/quote.py
# -*- coding: utf-8 -*-
from sqlalchemy import String, DateTime, Integer, Numeric, ForeignKey, Index
from sqlalchemy.dialects.mysql import BIGINT
from datetime import datetime
from extensions import db

class Quote(db.Model):
    __tablename__ = 'quotes'
    __table_args__ = (
        Index('idx_quotes_supplier_id', 'supplier_id'),
        Index('idx_quotes_purchase_request_id', 'purchase_request_id'),
        Index('idx_quotes_status', 'status'),
        Index('idx_quotes_created_at', 'created_at'),
    )

    id = db.Column(BIGINT(unsigned=True), primary_key=True, autoincrement=True)
    
    # 外键关系
    supplier_id = db.Column(BIGINT(unsigned=True), ForeignKey('suppliers.id', ondelete='CASCADE'), nullable=False)
    purchase_request_id = db.Column(BIGINT(unsigned=True), nullable=True)  # 采购申请ID
    
    # 基础信息
    quote_number = db.Column(String(100), unique=True, nullable=False)  # 报价单号
    item_name = db.Column(String(200), nullable=False)  # 物品名称
    item_description = db.Column(db.Text, nullable=True)  # 物品描述
    quantity_requested = db.Column(Integer, nullable=False)  # 请求数量
    unit = db.Column(String(50), nullable=True)  # 单位（个、箱、吨等）
    
    # 报价信息
    price = db.Column(Numeric(12, 2), nullable=True)  # 供应商报价
    tax_rate = db.Column(Numeric(5, 2), default=0, nullable=True)  # 税率
    total_price = db.Column(Numeric(12, 2), nullable=True)  # 总价
    currency = db.Column(String(10), default='CNY', nullable=False)  # 货币
    delivery_days = db.Column(Integer, nullable=True)  # 交付天数
    notes = db.Column(db.Text, nullable=True)  # 备注
    
    # 状态追踪
    status = db.Column(String(20), default='published', nullable=False)  
    # 可选值: published(已发布) / participated(已参与) / won(赢标) / lost(未赢标) / closed(已关闭)
    
    # 竞标信息
    total_participated = db.Column(Integer, default=0)  # 总参与方数
    participated_at = db.Column(DateTime, nullable=True)  # 供应商参与时间
    
    # 时间戳
    created_at = db.Column(DateTime, default=datetime.utcnow)
    updated_at = db.Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    deadline = db.Column(DateTime, nullable=True)  # 报价截止时间
    
    # 关系
    supplier = db.relationship('Supplier', backref='quotes', lazy=True)

    def __repr__(self):
        return f'<Quote {self.quote_number}>'

    def to_dict(self):
        return {
            'id': self.id,
            'quote_number': self.quote_number,
            'supplier_id': self.supplier_id,
            'purchase_request_id': self.purchase_request_id,
            'item_name': self.item_name,
            'item_description': self.item_description,
            'quantity_requested': self.quantity_requested,
            'unit': self.unit,
            'price': float(self.price) if self.price else None,
            'tax_rate': float(self.tax_rate) if self.tax_rate else 0,
            'total_price': float(self.total_price) if self.total_price else None,
            'currency': self.currency,
            'delivery_days': self.delivery_days,
            'notes': self.notes,
            'status': self.status,
            'total_participated': self.total_participated,
            'participated_at': self.participated_at.isoformat() if self.participated_at else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
            'deadline': self.deadline.isoformat() if self.deadline else None,
            'supplier': {
                'id': self.supplier.id,
                'company_name': self.supplier.company_name,
                'contact_name': self.supplier.contact_name,
                'contact_phone': self.supplier.contact_phone,
            } if self.supplier else None,
        }