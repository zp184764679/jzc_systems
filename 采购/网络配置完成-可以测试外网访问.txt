═══════════════════════════════════════════════════════════════
✅ 网络配置已全部完成！可以开始测试外网访问
═══════════════════════════════════════════════════════════════
完成时间: 2025-01-09

【已解决的问题】

✅ 1. Ethernet 4 网关配置 (根本原因)
   问题: Ethernet 4 (192.168.5.125) 没有配置默认网关
   影响: 外网流量进来后，无法正确路由返回
   解决: 配置默认网关为 192.168.5.1
   验证:
   - 网关配置成功 ✓
   - 路由表更新正确 ✓
   - 网关可达 (ping 1ms) ✓

✅ 2. WSL 端口转发配置
   配置:
   - 0.0.0.0:5001 → 172.22.47.181:5001 (后端API)
   - 0.0.0.0:3000 → 172.22.47.181:3000 (前端)
   验证: netsh interface portproxy show all ✓

✅ 3. Windows 防火墙规则
   规则:
   - WSL Backend API 5001: TCP 入站允许
   - WSL Frontend 3000: TCP 入站允许
   验证: netsh advfirewall firewall show rule ✓

✅ 4. 前端网络绑定
   配置: npm run dev -- --host
   监听: localhost:3000, 192.168.0.6:3000, 192.168.5.125:3000
   验证: HTTP 200 OK ✓

✅ 5. WSL 后端服务
   位置: ~/caigou-prod/backend
   服务: caigou-backend.service (systemd)
   监听: 0.0.0.0:5001
   验证: {"message": "Server is running", "status": "healthy"} ✓


【当前网络架构】

┌─────────────────────────────────────────────────────────────┐
│ 外网                                                         │
│   公网 IP: 61.145.212.28                                    │
│   ↓ (路由器DMZ映射)                                          │
│                                                              │
│ 内网                                                         │
│   ├─ Ethernet (192.168.0.6)                                │
│   │   网关: 192.168.1.1 ✓                                  │
│   │   状态: 正常                                            │
│   │                                                         │
│   └─ Ethernet 4 (192.168.5.125) ← DMZ映射目标              │
│       网关: 192.168.5.1 ✓ (刚刚配置)                       │
│       状态: 正常                                            │
│       ↓ (端口转发)                                          │
│                                                              │
│   WSL Ubuntu 22.04 (172.22.47.181)                         │
│       ├─ 后端 Flask: 0.0.0.0:5001 ✓                        │
│       ├─ Celery Worker ✓                                   │
│       ├─ Redis: localhost:6379 ✓                           │
│       └─ Ollama: localhost:11434 ✓                         │
│                                                              │
│   Windows 服务                                               │
│       ├─ MySQL 9.0: 172.22.32.1:3306 ✓                    │
│       └─ 前端 Vite: 0.0.0.0:3000 ✓                         │
└─────────────────────────────────────────────────────────────┘


【访问地址总结】

本机访问:
- 后端API: http://localhost:5001
- 前端页面: http://localhost:3000

局域网访问:
- 后端API: http://192.168.5.125:5001
- 前端页面: http://192.168.5.125:3000

公网访问 (需要路由器DMZ配置):
- 后端API: http://61.145.212.28:5001
- 前端页面: http://61.145.212.28:3000


【现在可以测试外网访问了！】

═══════════════════════════════════════════════════════════════
测试方法1: 使用手机4G网络测试 (推荐)
═══════════════════════════════════════════════════════════════

步骤：
1. 关闭手机WiFi，使用移动数据网络
2. 打开手机浏览器
3. 访问以下地址：

   测试后端API:
   http://61.145.212.28:5001/api/health

   预期返回:
   {
     "message": "Server is running",
     "status": "healthy"
   }

   测试前端页面:
   http://61.145.212.28:3000

   预期结果:
   看到前端登录页面


═══════════════════════════════════════════════════════════════
测试方法2: 使用在线端口检测工具
═══════════════════════════════════════════════════════════════

1. 打开网站:
   https://www.yougetsignal.com/tools/open-ports/

2. 输入信息:
   Remote Address: 61.145.212.28
   Port Number: 5001

3. 点击 "Check" 按钮

4. 预期结果:
   "Port 5001 is open on 61.145.212.28"

5. 再次测试3000端口:
   Port Number: 3000
   预期结果: "Port 3000 is open"


═══════════════════════════════════════════════════════════════
测试方法3: 从其他网络的电脑访问
═══════════════════════════════════════════════════════════════

从朋友的电脑或办公室其他网络访问：
- http://61.145.212.28:5001/api/health
- http://61.145.212.28:3000


═══════════════════════════════════════════════════════════════
如果外网访问仍然失败
═══════════════════════════════════════════════════════════════

Windows端配置已经完全正确，如果外网访问失败，问题在路由器：

检查项1: 路由器DMZ配置
─────────────────────────────────
登录路由器管理界面，确认：
□ DMZ功能已启用
□ DMZ主机IP设置为: 192.168.5.125
□ 保存并重启路由器

检查项2: 确认公网IP
─────────────────────────────────
1. 访问: https://www.ip.cn/
2. 确认显示的IP是否为: 61.145.212.28
3. 如果不是，可能是IP变化了，需要更新

检查项3: 运营商限制
─────────────────────────────────
某些运营商可能限制端口，尝试：
1. 联系运营商确认是否有端口限制
2. 询问是否提供了真实公网IP
3. 某些宽带是大内网(如100.x.x.x)，无法外网访问

检查项4: 双层路由器
─────────────────────────────────
如果有 光猫 + 路由器 双层：
1. 光猫需要设置DMZ指向路由器内网IP
2. 路由器设置DMZ指向: 192.168.5.125
3. 或者将光猫改为桥接模式，路由器拨号(推荐)


═══════════════════════════════════════════════════════════════
路由器DMZ配置参考
═══════════════════════════════════════════════════════════════

常见路由器配置路径:

TP-Link:
转发规则 → DMZ → 启用 → DMZ主机IP地址: 192.168.5.125

华为/荣耀:
更多功能 → 网络设置 → DMZ → 启用DMZ → 192.168.5.125

小米:
高级设置 → 端口转发 → DMZ → 192.168.5.125

华硕:
外部网络(WAN) → 虚拟服务器/端口转发 → DMZ → 192.168.5.125

水星:
转发规则 → DMZ主机 → 启用 → 192.168.5.125


═══════════════════════════════════════════════════════════════
备用方案: 手动端口映射
═══════════════════════════════════════════════════════════════

如果路由器不支持DMZ，使用端口映射(Port Forwarding):

外部端口  协议  内网IP         内网端口  说明
5001     TCP   192.168.5.125  5001     后端API
3000     TCP   192.168.5.125  3000     前端


═══════════════════════════════════════════════════════════════
Windows端验证命令 (所有配置均已成功)
═══════════════════════════════════════════════════════════════

验证Ethernet 4网关:
netsh interface ipv4 show config name="Ethernet 4"
预期: Default Gateway: 192.168.5.1 ✓

验证路由表:
route print | findstr "192.168.5"
预期: 0.0.0.0 0.0.0.0 192.168.5.1 192.168.5.125 ✓

验证网关连接:
ping 192.168.5.1
预期: Reply from 192.168.5.1: bytes=32 time=1ms ✓

验证端口转发:
netsh interface portproxy show all
预期:
  0.0.0.0:5001 → 172.22.47.181:5001 ✓
  0.0.0.0:3000 → 172.22.47.181:3000 ✓

验证防火墙规则:
netsh advfirewall firewall show rule name="WSL Backend API 5001"
预期: Enabled: Yes, Action: Allow ✓

验证内网访问:
curl http://192.168.5.125:5001/api/health
预期: {"message": "Server is running", "status": "healthy"} ✓

curl -I http://192.168.5.125:3000
预期: HTTP/1.1 200 OK ✓


═══════════════════════════════════════════════════════════════
系统服务管理 (WSL)
═══════════════════════════════════════════════════════════════

查看后端服务状态:
wsl -d Ubuntu-22.04 -- bash -c "sudo systemctl status caigou-backend"

重启后端服务:
wsl -d Ubuntu-22.04 -- bash -c "sudo systemctl restart caigou-backend"

查看后端日志:
wsl -d Ubuntu-22.04 -- bash -c "sudo journalctl -u caigou-backend -f"

查看Celery服务:
wsl -d Ubuntu-22.04 -- bash -c "sudo systemctl status caigou-celery"


═══════════════════════════════════════════════════════════════
配置文件位置
═══════════════════════════════════════════════════════════════

WSL后端配置:
~/caigou-prod/backend/.env

Windows前端配置:
C:\Users\Admin\Desktop\采购\frontend\.env

WSL端口转发脚本:
C:\Users\Admin\Desktop\采购\setup_wsl_port_forward.ps1

Ethernet 4网关配置脚本:
C:\Users\Admin\Desktop\采购\配置Ethernet4网关.ps1


═══════════════════════════════════════════════════════════════
总结
═══════════════════════════════════════════════════════════════

✅ Windows端所有配置已完成并验证通过！
✅ 内网访问测试成功！
✅ 网关配置成功！
✅ 端口转发配置成功！
✅ 防火墙规则配置成功！
✅ WSL服务运行正常！

🎯 现在可以测试外网访问了！

下一步：
1. 使用手机4G网络测试外网访问
2. 如果失败，检查路由器DMZ配置
3. 如果路由器配置正确但仍失败，联系运营商确认公网IP和端口限制

═══════════════════════════════════════════════════════════════
